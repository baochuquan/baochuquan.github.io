<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/chu.icon">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/chu.icon">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chuquan.me","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="概述 Mach-O 的全称是 Mach Object File Format，它可以用来表示可执行文件、目标代码或共享库、动态库等。Mach 内核的操作系统，如：macOS，iPadOS，iOS 采用的都是 Mach-O。本文我们来学习一下 Mach-O 的内部结构，通过学习 Mach-O，可以了解应用程序是如何加载到系统中的，如何执行的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mach-O 格式">
<meta property="og:url" content="http://chuquan.me/2020/09/14/mach-o-format/index.html">
<meta property="og:site_name" content="楚权的世界">
<meta property="og:description" content="概述 Mach-O 的全称是 Mach Object File Format，它可以用来表示可执行文件、目标代码或共享库、动态库等。Mach 内核的操作系统，如：macOS，iPadOS，iOS 采用的都是 Mach-O。本文我们来学习一下 Mach-O 的内部结构，通过学习 Mach-O，可以了解应用程序是如何加载到系统中的，如何执行的。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-14T07:39:17.000Z">
<meta property="article:modified_time" content="2023-09-16T11:45:21.864Z">
<meta property="article:author" content="Bao Chuquan">
<meta property="article:tag" content="Mach-O">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chuquan.me/2020/09/14/mach-o-format/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://chuquan.me/2020/09/14/mach-o-format/","path":"2020/09/14/mach-o-format/","title":"Mach-O 格式"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Mach-O 格式 | 楚权的世界</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?030cf08d5b27d756fa9aeecb1130fe13"></script>






<link rel="dns-prefetch" href="https://vercel.chuquan.me">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="楚权的世界" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="headband"></div>
  <a href="https://github.com/baochuquan"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">楚权的世界</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Seek the wonder of life.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#header"><span class="nav-number">3.</span> <span class="nav-text">Header</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#load-commands"><span class="nav-number">4.</span> <span class="nav-text">Load Commands</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#uuid_command"><span class="nav-number">4.1.</span> <span class="nav-text">uuid_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#segment_command"><span class="nav-number">4.2.</span> <span class="nav-text">segment_command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#section"><span class="nav-number">4.2.1.</span> <span class="nav-text">section</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#twolevel_hints_command"><span class="nav-number">4.3.</span> <span class="nav-text">twolevel_hints_command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#twolevel_hint"><span class="nav-number">4.3.1.</span> <span class="nav-text">twolevel_hint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lc_str"><span class="nav-number">4.3.2.</span> <span class="nav-text">lc_str</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dylib_command"><span class="nav-number">4.4.</span> <span class="nav-text">dylib_command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dylib"><span class="nav-number">4.4.1.</span> <span class="nav-text">dylib</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dylinker_command"><span class="nav-number">4.5.</span> <span class="nav-text">dylinker_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prebound_dylib_command"><span class="nav-number">4.6.</span> <span class="nav-text">prebound_dylib_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#thread_command"><span class="nav-number">4.7.</span> <span class="nav-text">thread_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#routines_command"><span class="nav-number">4.8.</span> <span class="nav-text">routines_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sub_framework_command"><span class="nav-number">4.9.</span> <span class="nav-text">sub_framework_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sub_umbrella_command"><span class="nav-number">4.10.</span> <span class="nav-text">sub_umbrella_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sub_library_command"><span class="nav-number">4.11.</span> <span class="nav-text">sub_library_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sub_client_command"><span class="nav-number">4.12.</span> <span class="nav-text">sub_client_command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#symtab_command"><span class="nav-number">4.13.</span> <span class="nav-text">symtab_command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nlist"><span class="nav-number">4.13.1.</span> <span class="nav-text">nlist</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dysymtab_command"><span class="nav-number">4.14.</span> <span class="nav-text">dysymtab_command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dylib_table_of_contents"><span class="nav-number">4.14.1.</span> <span class="nav-text">dylib_table_of_contents</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dylib_module"><span class="nav-number">4.14.2.</span> <span class="nav-text">dylib_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dylib_reference"><span class="nav-number">4.14.3.</span> <span class="nav-text">dylib_reference</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bao Chuquan"
      src="/images/SlamDunk.png">
  <p class="site-author-name" itemprop="name">Bao Chuquan</p>
  <div class="site-description" itemprop="description">积累，沉淀，吸收，转换</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">156</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">385</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/baochuquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;baochuquan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:baochuquan@gmail.com" title="E-Mail → mailto:baochuquan@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/baochuquan" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;baochuquan" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Baochuquan" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Baochuquan" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chuquan.me/2020/09/14/mach-o-format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/SlamDunk.png">
      <meta itemprop="name" content="Bao Chuquan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="楚权的世界">
      <meta itemprop="description" content="积累，沉淀，吸收，转换">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Mach-O 格式 | 楚权的世界">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mach-O 格式
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-14 15:39:17" itemprop="dateCreated datePublished" datetime="2020-09-14T15:39:17+08:00">2020-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-16 19:45:21" itemprop="dateModified" datetime="2023-09-16T19:45:21+08:00">2023-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2020/09/14/mach-o-format/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2020/09/14/mach-o-format/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="概述">概述</h1>
<p>Mach-O 的全称是 Mach Object File
Format，它可以用来表示可执行文件、目标代码或共享库、动态库等。Mach
内核的操作系统，如：macOS，iPadOS，iOS 采用的都是
Mach-O。本文我们来学习一下 Mach-O 的内部结构，通过学习
Mach-O，可以了解应用程序是如何加载到系统中的，如何执行的。</p>
<span id="more"></span>
<h1 id="基本结构">基本结构</h1>
<p>Mach-O 文件的内部组成可以分为三个部分：</p>
<ul>
<li><strong>Header</strong>
<ul>
<li>每一个 Mach-O 文件的起始部分，用于将文件标识为 Mach-O 文件。Header
还包含关于文件的其他信息，如：文件类型、CPU 架构类型等。</li>
</ul></li>
<li><strong>Load Commands</strong>：
<ul>
<li>Load Commands 包含了一系列不同的 <strong>加载命令（Load
Commands）</strong>，可用于指导如何设置并加载二进制数据。在 Mach-O
的文件布局中，Load Commands 紧跟在 Header 之后。Load Commands
有诸多功能，比如：
<ul>
<li>指定文件在虚拟内存中的初始布局</li>
<li>指定动态链接时的符号表位置</li>
<li>指定程序主线程的初始执行状态</li>
<li>指定共享库的名称，共享库包含程序所导入符号的定义。</li>
</ul></li>
</ul></li>
<li><strong>Data</strong>
<ul>
<li>Data 包含了多个 segment，每个 segment 包含 0 个或多个 section。每个
segment 中的 section 具有相同的类型，如：代码或数据。每个 segment
定义了一个虚拟内存区域，动态链接器能够将其映射到进程的地址空间。segment
和 section 的数量和布局则是由 load commands 和文件类型指定的。</li>
<li>对于用户级完全链接的 Mach-O 文件，其最后一个 segment 是
<strong>LINKEDIT</strong> segment。该 segment
包含了符号链接的信息表，如：符号表、字符串表等，动态链接器基于这些信息将可执行程序或
Mach-O bundle 与其依赖的库进行链接接。</li>
</ul></li>
</ul>
<p>下图所示为 Mach-O 文件的基本结构：</p>
<p><img
src="https://chuquan-public-r-001.oss-cn-shanghai.aliyuncs.com/blog-images/mach-o-overview.png?x-oss-process=image/resize,w_800" /></p>
<p>下面我们来对 Mach-O 文件 Header 和 Load Commands 进行着重分析。Load
Command 中涉及到的一些其他数据结构，如 section 则存储在 Data 之中。</p>
<h1 id="header">Header</h1>
<p>Header 的数据结构如下所示（在
<code>/usr/include/mach-o/loader.h</code> 中定义）： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	magic;		    <span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="type">cpu_type_t</span>	cputype;	    <span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="type">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="type">uint32_t</span>	filetype;	    <span class="comment">/* type of file */</span></span><br><span class="line">	<span class="type">uint32_t</span>	ncmds;		    <span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	sizeofcmds;	    <span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		    <span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>magic</code>
<ul>
<li>指定文件的类型为 Mach-O。如果文件希望其布局与 CPU 字节序相同，则使用
<code>MH_MAGIC</code>；如果文件希望其布局与 CPU 字节序相反，则使用
<code>MH_CIGAM</code>。</li>
</ul></li>
<li><code>cputype</code>
<ul>
<li>指定文件运行的目标架构，可能包含两种类型：
<ul>
<li><code>CPU_TYPE_POWERPC</code>：基于 PowerPC CPU 的 Mac 计算机。</li>
<li><code>CPU_TYPE_I386</code>：基于 Intel CPU 的 Mac 计算机。</li>
</ul></li>
</ul></li>
<li><code>cpusubtype</code>
<ul>
<li>指定 CPU 确切型号。如果希望能够 PowerPC 或 Intel
的所有处理器上执行，可以设置为 <code>CPU_SUBTYPE_POWERPC_ALL</code> 或
<code>CPU_SUBTYPE_I386_ALL</code>。</li>
</ul></li>
<li><code>filetype</code>
<ul>
<li>指定文件的类型。其包含以下这些值：
<ul>
<li><code>MH_OBJECT</code>：表示
<strong>中间目标文件</strong>。这是一种非常紧凑的格式，它将所有的
section 放在了一个 segment
中。<strong>编译器和汇编器通常会为每一个源代码文件生成一个中间目标文件，文件一般以
<code>.o</code> 作为后缀</strong>。</li>
<li><code>MH_EXECUTE</code>：表示
<strong>标准的可执行程序</strong>。</li>
<li><code>MH_BUNDLE</code>：表示 <strong>插件</strong> 或
<strong>bundle</strong>。非独立的二进制文件，<strong>由可执行文件显式进行加载</strong>。<strong>文件一般以
<code>.bundle</code> 作为后缀</strong>。</li>
<li><code>MH_DYLIB</code>：表示
<strong>动态共享库</strong>。其包含一些额外的表来支持多个模块。<strong>文件一般以
<code>.dylib</code> 作为后缀</strong>，framework
的主共享库除外，其没有文件后缀名。</li>
<li><code>MH_CORE</code>：表示
<strong>核心转储文件</strong>。操作系统会在程序崩溃时创建该文件。核心转储文件存储了程序崩溃时的完整地址空间。我们可以通过在核心转储文件上运行
<code>gdb</code> 来判断崩溃的原因。</li>
<li><code>MH_DYLINKER</code>：表示
<strong>动态链接器</strong>。<code>dyld</code> 的文件类型就是
<code>MH_DYLINKER</code>。</li>
<li><code>MH_DSYM</code>：表示
<strong>存储了二进制符号信息的文件</strong>。</li>
</ul></li>
</ul></li>
<li><code>ncmds</code>
<ul>
<li>指定 load commands 的数量。</li>
</ul></li>
<li><code>sizeofcmds</code>
<ul>
<li>指定 load commands 所占据的字节数。</li>
</ul></li>
<li><code>flags</code>
<ul>
<li>指定 Mach-O
文件的某些可选功能的状态，下面是一些我们可以操作该字段的掩码：
<ul>
<li><code>MH_NOUNDEFS</code>：表示目标文件在构建时不包含未定义的引用。</li>
<li><code>MH_INCRLNK</code>：表示目标文件是相对于一个基本文件的增量链接输出，无法再次链接。</li>
<li><code>MH_DYLDLINK</code>：表示目标文件是动态链接器的输入，无法再次静态链接。</li>
<li><code>MH_TWOLEVEL</code>：表示镜像采用二级命名空间绑定。</li>
<li><code>MH_BINDATLOAD</code>：表示当文件加载完毕之后，动态链接器应该对未定义引用进行绑定。</li>
<li><code>MH_PREBOUND</code>：表示文件的未定义引用是预先绑定的。</li>
<li><code>MH_PREBINDABLE</code>：表示文件没有预绑定，但是可以重新对其进行预绑定。<strong>仅在
<code>MH_PREBOUND</code> 未设置时使用</strong>。</li>
<li><code>MH_NOFIXPREBINDING</code>：表示动态链接器不会将关于此可执行文件的信息通知预绑定代理。</li>
<li><code>MH_ALLMODSBOUND</code>：表示将此二进制文件绑定到它所依赖的库的所有二级命名空间
module。<strong>仅在 <code>MH_PREBINDABLE</code> 和
<code>MH_TWOLEVEL</code> 设置时使用</strong>。</li>
<li><code>MH_CANONICAL</code>：表示文件已取消预绑定。</li>
<li><code>MH_SPLIT_SEGS</code>：表示文件的只读段和读写段是分离的。</li>
<li><code>MH_FORCE_FLAT</code>：表示可执行文件强制所有镜像使用扁平的命名空间绑定。</li>
<li><code>MH_SUBSECTIONS_VIA_SYMBOLS</code>：表示目标文件的 sections
可以分为独立的块。如果其他代码未使用这些块，则会被清理掉。</li>
<li><code>MH_NOMULTIDEFS</code>：表示确保子镜像没有针对同一符号的多种定义。因此可以使用两级命名空间提示。</li>
</ul></li>
</ul></li>
</ul>
<p><strong>注意</strong>：对于所有的文件类型（<code>MH_OBJECT</code>
除外），对于给定的 CPU 架构，segments 必须页对齐：PowerPC 和 x86
处理器的页面大小均为 4KB。这使得内核能够直接为 segment
分配虚拟内存页面。</p>
<h1 id="load-commands">Load Commands</h1>
<p>Load commands 位于 Header
之后，它们用于指定文件的逻辑结构、文件在虚拟内存中的布局。所有类型的
<strong>加载命令</strong>
都具有相同的两个字段，用于指定命令类型以及命令数据的大小，如下所示：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> cmd;		<span class="comment">/* type of load command */</span></span><br><span class="line">	<span class="type">uint32_t</span> cmdsize;	<span class="comment">/* total size of command in bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>cmd</code>
<ul>
<li>指定加载命令的类型。下面列出了有效的加载命令的类型。
<ul>
<li><code>LC_UUID</code>：表示 <code>uuid_command</code>
加载命令。用于指定一个镜像或其对应的 dSYM 文件的 128 位 UUID。</li>
<li><code>LC_SEGMENT</code>：表示 <code>segment_command</code>
加载命令。将指定的 segment
映射到加载此文件的进程的地址空间中。此外，还定义了 segment 所包含的所有
sections。</li>
<li><code>LC_SYMTAB</code>：表示 <code>symtab_command</code>
加载命令。用于指定此文件的符号表。<strong>动态链接或静态链接此文件时都会调用符号表信息，调试器也使用符号表将符号映射到生成符号的原始代码文件</strong>。</li>
<li><code>LC_DYSYMTAB</code>：表示 <code>dysymtab_command</code>
加载命令。用于指定
<strong>动态链接器使用的额外符号表信息</strong>。</li>
<li><code>LC_THREAD</code>、<code>LC_UNIXTHREAD</code>：表示
<code>thread_command</code>
加载命令。对于可执行文件，<code>LC_UNIXTHREAD</code>
定义了进程主线程的初始化状态；<code>LC_THREAD</code> 与
<code>LC_UNIXTHREAD</code> 类似，但是不会导致内核分配栈区。</li>
<li><code>LC_LOAD_DYLIB</code>：表示 <code>dylib_command</code>
加载命令。用于定义此文件会链接的动态链接库的名称。</li>
<li><code>LC_ID_DYLIB</code>：表示 <code>dylib_command</code>
加载命令。用于定义动态链接器的名称。</li>
<li><code>LC_PREBOUND_DYLIB</code>：表示
<code>prebound_dylib_command</code>
加载命令。对于此文件预先链接到的共享库，通过此加载命令指定共享库中使用的
module。</li>
<li><code>LC_LOAD_DYLINKER</code>：表示 <code>dylinker_command</code>
加载命令。用于指定
<strong>内核加载此文件所使用的动态链接器</strong>。</li>
<li><code>LC_ID_DYLINKER</code>：表示 <code>dylinker_command</code>
加载命令。用于指定此文件是动态链接器。</li>
<li><code>LC_ROUTINES</code>：表示 <code>routines_command</code>
加载命令。包含共享库初始化进程的地址。</li>
<li><code>LC_TWOLEVEL_HINTS</code>：表示
<code>twolevel_hints_command</code>
加载命令。包含两级命名空间查找表。</li>
<li><code>LC_SUB_FRAMEWORK</code>：表示
<code>sub_framework_command</code> 加载命令。将此文件标识为 umbrella
framework 的子 framework 的实现。umbrella framework
的名称存储在字符串参数中。</li>
<li><code>LC_SUB_UMBRELLA</code>：表示 <code>sub_umbrella_command</code>
加载命令。将一个文件标记为此 umbrella framework 的子 umbrella。</li>
<li><code>LC_SUB_LIBRARY</code>：表示 <code>sub_library_command</code>
加载命令。用于定义 <code>LC_SUB_LIBRARY</code> 加载命令的属性，标识为此
framework 的子 library，并将该 framework 标记为一个 umbrella
framework。</li>
<li><code>LC_SUB_CLIENT</code>：表示 <code>sub_client_command</code>
加载命令。当包含 <code>LC_SUB_CLIENT</code> 加载命令，且包含另一个
framework 或 bundle 的名称时，子 framework 就可以允许被它们所链接。</li>
</ul></li>
</ul></li>
<li><code>cmdsize</code>
<ul>
<li>指定数据结构的大小，以字节为单位。不同类型的加载命令，除了包含上述两个基本字段之外，还包含其他的数据字段。</li>
</ul></li>
</ul>
<p>表：</p>
<p>下面依次来介绍各种不同类型的加载命令。</p>
<h2 id="uuid_command">uuid_command</h2>
<p><code>uuid_command</code> 加载命令用于指定镜像或其对应的 dSYM 文件的
128 位通用唯一标识符（UUID）。<code>uuid_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uuid_command</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_UUID */</span></span><br><span class="line">    <span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct uuid_command) */</span></span><br><span class="line">    <span class="type">uint8_t</span>	uuid[<span class="number">16</span>];	<span class="comment">/* the 128-bit uuid */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>uuid</code>
<ul>
<li>128 位的 UUID。</li>
</ul></li>
</ul>
<h2 id="segment_command">segment_command</h2>
<p><code>segment_command</code> 命令用于指定一个 segment
的字节范围，该范围中的数据通过加载器映射到程序的地址空间。<code>segment_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segment_command</span> &#123;</span> <span class="comment">/* for 32-bit architectures */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SEGMENT */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes sizeof section structs */</span></span><br><span class="line">	<span class="type">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment name */</span></span><br><span class="line">	<span class="type">uint32_t</span>	vmaddr;		<span class="comment">/* memory address of this segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	vmsize;		<span class="comment">/* memory size of this segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	fileoff;	<span class="comment">/* file offset of this segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	filesize;	<span class="comment">/* amount to map from the file */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	maxprot;	<span class="comment">/* maximum VM protection */</span></span><br><span class="line">	<span class="type">vm_prot_t</span>	initprot;	<span class="comment">/* initial VM protection */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nsects;		<span class="comment">/* number of sections in segment */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>segname</code>
<ul>
<li>用于描述 segment 名称的 C 字符串。<strong>苹果定义 segment
名称以两个下划线为前缀，并由大写字母组成，如：<code>__TEXT</code>、<code>__DATA</code></strong>。</li>
</ul></li>
<li><code>vmaddr</code>
<ul>
<li>指定 segment 在虚拟内存中的起始地址。</li>
</ul></li>
<li><code>vmsize</code>
<ul>
<li>指定 segment 在虚拟内存中占据的字节数。</li>
</ul></li>
<li><code>fileoff</code>
<ul>
<li>指定要映射到 <code>vmaddr</code> 位置的数据在此文件中的偏移。</li>
</ul></li>
<li><code>filesize</code>
<ul>
<li>指定 segment 在磁盘上占据的字节数。对于运行时比构建时需要更多内存的
segment，<code>vmsize</code> 可以大于
<code>filesize</code>。比如，链接器为 <code>MH_EXECUTABLE</code>
文件生成的 <code>__PAGESIZE</code> segment，其 <code>vmsize</code> 是
<code>0x1000</code>，而 <code>filesize</code> 却是 <code>0</code>。因为
<code>__PAGEZERO</code>
不包含数据，因此在运行前没有必要占据任何空间。类似的，静态链接器通常在
<code>__DATA</code> segment 的末尾分配未初始化的数据。</li>
</ul></li>
<li><code>maxprot</code>
<ul>
<li>指定 segment 的最大允许的虚拟内存保护级别。</li>
</ul></li>
<li><code>initprot</code>
<ul>
<li>指定 segment 的初始化虚拟内存保护级别。</li>
</ul></li>
<li><code>nsects</code>
<ul>
<li>指定紧跟在此加载命令之后的 section 数量。</li>
</ul></li>
<li><code>flags</code>
<ul>
<li>定义一组影响 segment 加载的标志位，如下：
<ul>
<li><code>SG_HIGHVM</code>：segment
的文件内容占虚拟内存空间的高位部分，低位部分填充零。</li>
<li><code>SG_NORELOC</code>：segment
没有任何重定位的内容，也没有要重定位的内容。</li>
</ul></li>
</ul></li>
</ul>
<p>Segment 定义了 Mach-O
中的一段字节，并定义了当这段字节映射到到虚拟内存时的地址和内存保护级别。比如，segment
始终关于虚拟内存页面对齐的。一个 segment 包含 0 个或多个
section。相比加载前，运行时的 segment
可能需要更多的内存。比如：由链接器为 PowerPC
生成的可执行文件中，<code>__PAGEZERO</code> segment 虚拟内存大小为 1
页，但在磁盘上的大小却为 0。由于 <code>__PAGEZERO</code>
不包含任何数据，因此不需要占用可执行文件中的任何空间。</p>
<p>为了紧凑起见，中间目标文件仅包含一个 segment。该 segment
没有名称，它包含所有的 section。</p>
<p>以下是 OS X 可执行文件中可能会包含的 segment：</p>
<ul>
<li><code>__PAGEZERO</code>：静态链接器创建 <code>__PAGEZERO</code>
segment 作为可执行文件的第一个 segment。该 segment 的虚拟内存地址为
0，并且未分配保护权限，这些权限的组合会导致对 NULL
的访问立即崩溃。<code>__PAGEZERO</code> segment
的大小为当前体系结构的一个完整 VM 页面的大小。<code>__PAGEZERO</code>
segment 中没有数据，所以它在文件中不占空间。</li>
<li><code>__TEXT</code>：<code>__TEXT</code> segment
包含可执行代码和其他只读数据。为了允许内核将其直接从可执行文件映射到可共享的内存，静态链接器将此
segment 的虚拟内存权限设置为禁止写入。当该 segment
映射到内存中时，可以在对其内存感兴趣的进程之间进行共享。（这主要用于
framework，bundle 以及共享库，但是可以在 OS X
中运行同一可执行文件的多个副本，在这种情况下也是如此。）只读属性还表示页面组成
<code>__TEXT</code> segment
的文件永远都不需要写回到磁盘。当内核需要释放物理内存时，它可以简单地丢弃一个或多个
<code>__TEXT</code> 页面，并在下次需要它们时从磁盘中重新读取。</li>
<li><code>__DATA</code>：<code>_DATA</code> segment
包含可写数据。静态链接器设置此 segment
的虚拟内存权限为允许读写。因为是可写的，所以在逻辑上会为与该库连接的每个进程复制框架或共享库的
<code>__DATA</code> segment。当组成 <code>__DATA</code> segment
的内存页是可读写时，内核将其标记为
<strong>写时复制</strong>（Copy-on-write）。因此，当一个进程写入这些页面时，该进程将会得到属于自己的页面私有副本。</li>
<li><code>__OBJC</code>：<code>__OBJC</code> segment 包含由 Objective-C
语言运行时支持的库所使用的数据。</li>
<li><code>__IMPORT</code>：<code>IMPORT</code> segment
包含符号插桩以及指向可执行文件中未定义符号的非惰性指针。只有 IA-32
体系结构的可执行文件会生成此 segment。</li>
<li><code>__LINKEDIT</code>：<code>__LINKEDIT</code> segment
包含动态链接器所需要的原始数据，如：符号、字符串、重定位表项。</li>
</ul>
<h3 id="section">section</h3>
<p>紧跟在 <code>segment_command</code> 数据结构之后的是一个 section
数据结构的数组，section 的数量由 <code>segment_command</code> 的
<code>nsects</code> 字段确定。多个 section 组成一个 segment。</p>
<p><code>section</code> 的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">section</span> &#123;</span>                <span class="comment">/* for 32-bit architectures */</span></span><br><span class="line">	<span class="type">char</span>		sectname[<span class="number">16</span>];	<span class="comment">/* name of this section */</span></span><br><span class="line">	<span class="type">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment this section goes in */</span></span><br><span class="line">	<span class="type">uint32_t</span>	addr;		    <span class="comment">/* memory address of this section */</span></span><br><span class="line">	<span class="type">uint32_t</span>	size;		    <span class="comment">/* size in bytes of this section */</span></span><br><span class="line">	<span class="type">uint32_t</span>	offset;		    <span class="comment">/* file offset of this section */</span></span><br><span class="line">	<span class="type">uint32_t</span>	align;		    <span class="comment">/* section alignment (power of 2) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reloff;	    	<span class="comment">/* file offset of relocation entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nreloc;		    <span class="comment">/* number of relocation entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	flags;	    	<span class="comment">/* flags (section type and attributes)*/</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved1;  	<span class="comment">/* reserved (for offset or index) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved2;	    <span class="comment">/* reserved (for count or sizeof) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>sectname</code>
<ul>
<li>指定 section 的名称。<strong>苹果定义 section
的名称以两个下划线开头，并由小写字母组成，如：<code>__text</code>、<code>__data</code></strong>。</li>
</ul></li>
<li><code>segname</code>
<ul>
<li>指定最终应包含此 section 的 segment
的名称。为了紧凑起见，中间目标文件（<code>MH_OBJECT</code>
类型的文件）仅包含一个 segment，所有的 section
都放在其中。静态链接器在构建最终产物（非 <code>MH_OBJECT</code>
类型的文件）时，会将每个 section 放在指定的 segment 中。</li>
</ul></li>
<li><code>addr</code>
<ul>
<li>指定 section 在虚拟内存中的起始地址。</li>
</ul></li>
<li><code>size</code>
<ul>
<li>指定 section 在虚拟内存中占据的字节数。</li>
</ul></li>
<li><code>offset</code>
<ul>
<li>指定 section 在此文件中的偏移。</li>
</ul></li>
<li><code>align</code>
<ul>
<li>指定 section 的对齐方式。</li>
</ul></li>
<li><code>reloff</code>
<ul>
<li>指定 section 的第一个重定位项在文件中的偏移。</li>
</ul></li>
<li><code>nreloc</code>
<ul>
<li>指定 section 的重定位项的数量。</li>
</ul></li>
<li><code>flags</code>
<ul>
<li>该字段可分为两个部分：低 8 位指定 section 的类型、高 24 位包含指定
section
的其他属性的一组标志。这些类型和标志主要被静态链接器和文件分析工具（如：<code>otool</code>）用来确定如何修改或显示
section。section 的类型有以下这些：
<ul>
<li><code>S_REGULAR</code>：表示 section
没有特殊类型。<strong>标准工具创建的 <code>__TEXT,__text</code> 就是此类
section</strong>。</li>
<li><code>S_ZEROFILL</code>：<strong>按需填充零</strong>，当首次读取或写入该
section 时，其中的每个页面都会自动填充零。</li>
<li><code>S_CSTRING_LITERALS</code>：表示 section 只包含常量 C
字符传。<strong>标准工具创建的 <code>__TEXT,__cstring</code> 就是此类
section</strong>。</li>
<li><code>S_4BYTE_LITERALS</code>：表示 section 只包含 4
字节长的常量值。<strong>标准工具创建的 <code>__TEXT,__literal4</code>
就是此类 section</strong>。</li>
<li><code>S_8BYTE_LITERALS</code>：表示 section 只包含 8
字节长的常量值。<strong>标准工具创建的 <code>__TEXT,__literal8</code>
就是此类 section</strong>。</li>
<li><code>S_NON_LAZY_SYMBOL_POINTERS</code>：表示 section
只包含符号的非惰性指针。<strong>标准工具创建的
<code>__DATA,__nl_symbol_ptrs</code> 就是此类 section</strong>。</li>
<li><code>S_LAZY_SYMBOL_POINTERS</code>：表示 section
只包含符号的惰性指针。<strong>标准工具创建的
<code>__DATA,__la_symbol_ptrs</code> 就是此类 section</strong>。</li>
<li><code>S_SYMBOL_STUBS</code>：表示 section
只包含符号插桩（stub）。<strong>标准工具创建的
<code>__TEXT,__symbol_stub</code> 和
<code>__TEXT,__picsymbol_stub</code> 就是此类 section</strong>。</li>
<li><code>S_MOD_INIT_FUNC_POINTERS</code>：表示 section
只包含指向模块构建方法的指针。<strong>标准工具创建的
<code>__DATA,__mod_init_func</code> 就是此类 section</strong>。</li>
<li><code>S_MOD_TERM_FUNC_POINTERS</code>：表示 section
只包含指向模块析构方法的指针。<strong>标准工具创建的
<code>__DATA,__mod_term_func</code> 就是此类 section</strong>。</li>
<li><code>S_COALESCED</code>：表示 section
只包含由静态链接器或动态链接器合并的符号。多个文件包含同一符号的合并定义，而不会引起
<code>multiple-defined-symbol</code> 报错。</li>
<li><code>S_GB_ZEROFILL</code>：表示 section 是一个按需填充零的
section。section 可以大于 4 GB。该 section 只能放在仅包含零填充 section
的 segment 中。如果将零填充 section 放在包含非零填充 section 的 segment
中，那么可能会导致这些 section
无法没读取。最终导致静态链接器无法生成输出文件。</li>
</ul></li>
<li>section 的属性有以下这些：
<ul>
<li><code>S_ATTR_PURE_INSTRUCTIONS</code>：表示 section
只包含可执行机器码。<strong>标准工具会为
<code>__TEXT,__text</code>、<code>__TEXT,__symbol_stub</code>、<code>__TEXT,__picsymbol_stub</code>
等 section 设置该属性</strong>。</li>
<li><code>S_ATTR_SOME_INSTRUCTIONS</code>：表示 section
包含一部分可执行机器码。</li>
<li><code>S_ATTR_NO_TOC</code>：表示 section 包含合并符号。</li>
<li><code>S_ATTR_EXT_RELOC</code>：表示 section
包含必须要被重定位的引用。这些引用引用其他文件中的数据（未定义符号）。为了支持外部重定位，包含此
section 的 segment 的最大虚拟内存保护级别必须允许读取和写入。</li>
<li><code>S_ATTR_LOC_RELOC</code>：表示 section
包含的引用必须被重定位。它们引用的是此文件中的数据。</li>
<li><code>S_ATTR_STRIP_STATIC_SYMS</code>：如果镜像的
<code>mach_header</code> 中的 <code>MH_DYLDLINK</code>
标志位被设置了，那么 section 中的静态符号就可以被删除。</li>
<li><code>S_ATTR_NO_DEAD_STRIP</code>：表示 section
的内容如果没有被引用，不能被删除。</li>
<li><code>S_ATTR_LIVE_SUPPORT</code>：如果 section
引用的代码存在，但是无法检测到该引用，那么不能被删除。</li>
</ul></li>
</ul></li>
</ul>
<p>Mach-O 文件中的每个 section
都具有类型和一组属性标志位。在中间目标文件中，静态链接器通过 section
的类型和属性决定如何将这些 section
拷贝到最终产物中。目标文件分析工具（如：<code>otool</code>）使用 section
的类型和属性来确定如何读取和显示 section。动态链接器也会用到某些 section
类型和属性。</p>
<p>以下是一些重要的符号类型和属性的静态链接变体：</p>
<ul>
<li><strong>regular section</strong>：在一个 regular section
中，一个外部符号只能有一个定义存在于中间目标文件。如果静态链接器找到两个外部符号的定义，则会报错。</li>
<li><strong>coalesced section</strong>：在最终的产物中，静态链接器对于
coalesced section
中的每一个符号只保留一个定义。为了支持复杂的语言特性（如 C++ 的虚表和
RTTI），编译器可以在每个中间目标文件中为一个特定的符号创建一个定义。之后，静态链接器和动态链接器会将重复的定义减少为单个定义。</li>
<li><strong>带弱定义的 coalesced
section</strong>：弱符号定义只可能出现在 coalesced section
中。当静态链接器找到符号的重复定义时，它会丢弃任何具有弱定义属性的合并符号定义。如果没有非弱定义，则是会用第一个弱定义。此功能旨在支持
C++ 模板。它允许显式模板实例覆盖隐式模板实例。C++ 编译器将显式定义放在
regular section 中，并将隐式定义放在 coalesced section
中，并标记为弱定义。用弱定义构建的的中间目标文件（以及静态归档库）只能与
OX X v10.2
及更高版本中的静态链接器一起使用。如果最终产物（应用程序和共享库）应该在
OS X 的早期版本中使用，则不应包含较弱的定义。</li>
</ul>
<p>以下是 <code>__TEXT</code> segment 中的几种 section：</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Segment and Section</th>
<th style="text-align: left;">content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>__TEXT,__text</code></td>
<td
style="text-align: left;">可执行的机器码。编译器通常在此部分中放置可执行代码，而不放置任何形式的表或数据。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__TEXT,__cstring</code></td>
<td style="text-align: left;">常量 C 字符串。C
字符串是一系列非空字节，以空字节 <code>\0</code>
结尾。静态链接器会在构建最终产物时合并 C 字符串常量，并删除重复项。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__TEXT,__picsymbol_stub</code></td>
<td style="text-align: left;">与位置无关的间接符号插桩。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__TEXT,__symbol_stub</code></td>
<td style="text-align: left;">间接符号插桩。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__TEXT,__const</code></td>
<td style="text-align: left;">初始化的常量。编译器将所有声明为 const
的不可重定位数据放在此 section 中。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__TEXT,__literal4</code></td>
<td style="text-align: left;">4 字节文本值。编译器在此 section
中放置单精度浮点常量。在构建最终产物时，静态链接器会合并这些值，并删除重复项。在某些架构中，编译器使用即时加载指令比添加到此
section 中更加高效。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__TEXT,__literal8</code></td>
<td style="text-align: left;">8 字节文本值。同上</td>
</tr>
</tbody>
</table>
<p>以下是 <code>__DATA</code> segment 中的几种 section：</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Segment and Section</th>
<th style="text-align: left;">content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>__DATA,__data</code></td>
<td style="text-align: left;">初始化的可变变量，例如可写的 C
字符串和数据数组。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__DATA,__la_symbol_ptr</code></td>
<td
style="text-align: left;">惰性符号指针，它们是对从其他文件导入的函数的间接引用。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__DATA,__nl_symbol_ptr</code></td>
<td
style="text-align: left;">非惰性符号指针，它们是对从其他文件导入的数据项的间接引用。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__DATA,__dyld</code></td>
<td style="text-align: left;">动态链接器使用的占位 section。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__DATA,__const</code></td>
<td style="text-align: left;">初始化的可重定位常量变量。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__DATA,__mod_init_func</code></td>
<td style="text-align: left;">模块构造函数。C++
编译器将静态构造函数放在此处。</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__DATA,__mod_term_func</code></td>
<td style="text-align: left;">模块析构函数。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>__DATA,__bss</code></td>
<td style="text-align: left;">未初始化的静态变量的数据，例如
<code>static int i;</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>__DATA,__common</code></td>
<td
style="text-align: left;">位于全局范围内（函数声明之外）的未初始化的导入符号定义，例如，<code>int i;</code></td>
</tr>
</tbody>
</table>
<p>以下是 <code>__IMPORT</code> segment 中的几种 section： |Segment and
Section | content | |:---|:---|
|<code>__IMPORT,__jump_table</code>|动态库中的函数调用插桩。|
|<code>__IMPORT,__pointers</code>|非惰性符号指针，它们是对从其他文件中导入的函数的直接引用。|</p>
<h2 id="twolevel_hints_command">twolevel_hints_command</h2>
<p><code>twolevel_hints_command</code> 的数据结构定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">twolevel_hints_command</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> cmd;	    <span class="comment">/* LC_TWOLEVEL_HINTS */</span></span><br><span class="line">    <span class="type">uint32_t</span> cmdsize;	<span class="comment">/* sizeof(struct twolevel_hints_command) */</span></span><br><span class="line">    <span class="type">uint32_t</span> offset;	<span class="comment">/* offset to the hint table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nhints;	<span class="comment">/* number of hints in the hint table */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>offset</code>
<ul>
<li>指定 <code>twolevel_hint</code> 数组在文件中的偏移。</li>
</ul></li>
<li><code>nhints</code>
<ul>
<li>指定 <code>twolevel_hint</code> 的数量。</li>
</ul></li>
</ul>
<p>静态链接器在编译一个两级命名空间镜像时，会将
<code>LC_TWOLEVEL_HINTS</code>
加载命令、两级命名空间提示表写入输出文件中。</p>
<p>默认，<code>ld</code> 不会在 <code>MH_BUNDLE</code> 中写入
<code>LC_TWOLEVEL_HINTS</code> 加载命令和两级命名空间提示表。</p>
<h3 id="twolevel_hint">twolevel_hint</h3>
<p><code>twolevel_hint</code>
用于表示两级命名空间提示表中的一个项。<code>twolevel_hint</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">twolevel_hint</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> </span><br><span class="line">	isub_image:<span class="number">8</span>,	<span class="comment">/* index into the sub images */</span></span><br><span class="line">	itoc:<span class="number">24</span>;	    <span class="comment">/* index into the table of contents */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>isub_image</code>
<ul>
<li>表示符号已定义的子镜像（subimage）。用来索引组成综合镜像（umbrella
image）的子镜像。如果该字段为
0，则表示符号位于综合镜像中。如果镜像不是一个 umbrella framework 或
library，那么该字段也是 0。</li>
</ul></li>
<li><code>itoc</code>
<ul>
<li><code>isub_image</code> 所指定镜像的符号索引。</li>
</ul></li>
</ul>
<p>两级命名空间提示表为动态链接器提供了建议的位置，从而在当前镜像所链接的库中搜索符号。</p>
<p>两级命名空间镜像中每一个未定义的符号在二级命名空间提示表中有着对应的索引项。</p>
<p><strong>静态链接器在构建两级命名空间镜像时将
<code>LC_TWOLEVEL_HINTS</code>
加载命令和两级命名空间提示表写入到输出文件中。</strong></p>
<p><strong>默认情况下，链接器不会在 <code>MH_BUNDLE</code> 文件中写入
<code>LC_TWOLEVEL_HINTS</code>
加载命令和两级命名空间提示表。</strong></p>
<h3 id="lc_str">lc_str</h3>
<p><code>lc_str</code> 用于定义一个可变长度的字符串。<code>lc_str</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">lc_str</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	offset;	<span class="comment">/* offset to the string */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LP64__</span></span><br><span class="line">	<span class="type">char</span>		*ptr;	<span class="comment">/* pointer to the string */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>offset</code>
<ul>
<li>表示从包含此字符串的加载命令的开始到字符串数据开始的偏移。</li>
</ul></li>
<li><code>ptr</code>
<ul>
<li>表示指向字节数组的指针。在运行时，该指针包含字符串数据的虚拟内存地址。在
Mach-O 文件中没有使用 <code>ptr</code> 字段。</li>
</ul></li>
</ul>
<p>加载命令使用 <code>lc_str</code>
数据结构存储可变长度的数据，如库名。除非另有说明，否则数据由 C
字符串组成。</p>
<p>指针指向的数据存储在加载命令之后，并且将数据大小存储在加载命令之中。该字符串应该以
null 终止。我们还可以通过从加载命令数据结构的 <code>cmdsize</code>
字段减去加载命令数据结构大小来确定字符串的大小。</p>
<h2 id="dylib_command">dylib_command</h2>
<p><code>dylib_command</code> 的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_ID_DYLIB, LC_LOAD_&#123;,WEAK_&#125;DYLIB, LC_REEXPORT_DYLIB */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes pathname string */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dylib</span>	<span class="title">dylib</span>;</span>	<span class="comment">/* the library identification */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>dylib</code>
<ul>
<li>用于描述共享库的属性。</li>
</ul></li>
</ul>
<p><strong>对于文件所链接的每一个共享库，静态链接器都会创建一个
<code>LC_LOAD_DYLIB</code> 加载命令，并且将其 <code>dylib</code>
字段设置为目标库的 <code>LC_ID_DYLD</code> 加载命令的 <code>dylib</code>
字段值。所有 <code>LC_LOAD_DYLIB</code>
加载命令组成一个列表，该列表根据文件中的位置进行排序，最早的
<code>LC_LOAD_DYLIB</code>
命令在列表的最前面。对于两级命名空间文件，符号表中未定义的符号项通过索引此列表来引用其父级共享库。该索引称之为
<code>library ordinal</code>，它存储在 <code>nlist</code> 数据结构的
<code>n_desc</code> 字段中。</strong></p>
<p><strong>在运行时，动态链接器使用 <code>LC_LOAD_DYLIB</code>
加载命令的 <code>dyld</code>
字段中的名称来查找共享库</strong>。如果找到了库，则动态链接器会将
<code>LC_LOAD_DYLIB</code>
加载命令的版本信息与库的版本信息进行比较。为了使动态链接器能够成功链接共享库，共享库的兼容版本必须小于等于
<code>LC_LOAD_DYLIB</code> 加载命令中的兼容版本。</p>
<p>动态链接器使用时间戳来确定它是否可以使用预绑定信息。当前版本由
<code>NSVersionOfRunTimeLibrary</code>
函数返回，从而允许你确定程序正在使用的库的版本。</p>
<h3 id="dylib">dylib</h3>
<p>动态链接器使用 <code>dylib</code> 来匹配要链接的共享库。仅在
<code>dylib_command</code> 加载命令中被用到。</p>
<p><code>dylib</code> 的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">lc_str</span>  <span class="title">name</span>;</span>			<span class="comment">/* library&#x27;s path name */</span></span><br><span class="line">    <span class="type">uint32_t</span> timestamp;			<span class="comment">/* library&#x27;s build time stamp */</span></span><br><span class="line">    <span class="type">uint32_t</span> current_version;		<span class="comment">/* library&#x27;s current version number */</span></span><br><span class="line">    <span class="type">uint32_t</span> compatibility_version;	<span class="comment">/* library&#x27;s compatibility vers number*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>name</code>
<ul>
<li><code>lc_str</code> 类型的数据结构。用于指定共享库的名称。</li>
</ul></li>
<li><code>timestamp</code>
<ul>
<li>表示共享库构建的时间戳。</li>
</ul></li>
<li><code>current_version</code>
<ul>
<li>表示共享库的当前版本。</li>
</ul></li>
<li><code>compatibility_version</code>
<ul>
<li>表示共享库的兼容版本。</li>
</ul></li>
</ul>
<h2 id="dylinker_command">dylinker_command</h2>
<p><code>dylinker_command</code> 的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylinker_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_ID_DYLINKER, LC_LOAD_DYLINKER or LC_DYLD_ENVIRONMENT */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes pathname string */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span>    <span class="title">name</span>;</span>	<span class="comment">/* dynamic linker&#x27;s path name */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>name</code>
<ul>
<li><code>lc_str</code> 类型的数据结构。用于指定动态链接器的名称。</li>
</ul></li>
</ul>
<p><strong>动态链接的每个可执行文件都包含一个
<code>LC_LOAD_DYLINKER</code>
加载命令，该命令指定内核必须加载指定名称的动态链接器。动态链接器本身使用
<code>LC_ID_DYLINKER</code> 加载命令指定其名称</strong>。</p>
<h2 id="prebound_dylib_command">prebound_dylib_command</h2>
<p>对于可执行文件链接到的每一个预绑定的库，静态链接器都会添加一个
<code>LC_PREBOUND_DYLIB</code> 命令。</p>
<p><code>prebound_dylib_command</code> 的数据结构定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prebound_dylib_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		        <span class="comment">/* LC_PREBOUND_DYLIB */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	        <span class="comment">/* includes strings */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span>	<span class="title">name</span>;</span>		    <span class="comment">/* library&#x27;s path name */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nmodules;	        <span class="comment">/* number of modules in library */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span>	<span class="title">linked_modules</span>;</span>	<span class="comment">/* bit vector of linked modules */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>name</code>
<ul>
<li><code>lc_str</code>
类型的数据结构。用于指定预绑定共享库的名称。</li>
</ul></li>
<li><code>nmodules</code>
<ul>
<li>指定预绑定共享库所包含模块的数量。</li>
</ul></li>
<li><code>linked_modules</code>
<ul>
<li><code>lc_str</code>
类型的数据结构。它是一个可变长度的位集，每个位表示相应的模块是否已经链接到当前文件中，1
表示是，0 表示否。第一个模块是第一个字节的低位。</li>
</ul></li>
</ul>
<h2 id="thread_command">thread_command</h2>
<p><code>thread_command</code> 的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_THREAD or  LC_UNIXTHREAD */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* total size of this command */</span></span><br><span class="line">	<span class="comment">/* uint32_t flavor		   flavor of thread state */</span></span><br><span class="line">	<span class="comment">/* uint32_t count		   count of uint32_t&#x27;s in thread state */</span></span><br><span class="line">	<span class="comment">/* struct XXX_thread_state state   thread state for this flavor */</span></span><br><span class="line">	<span class="comment">/* ... */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="routines_command">routines_command</h2>
<p><code>routines_command</code>
描述共享库构建函数的位置，动态链接器会在调用任何程序之前调用该函数。<code>routines_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">routines_command</span> &#123;</span> <span class="comment">/* for 32-bit architectures */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		    <span class="comment">/* LC_ROUTINES */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	    <span class="comment">/* total size of this command */</span></span><br><span class="line">	<span class="type">uint32_t</span>	init_address;	<span class="comment">/* address of initialization routine */</span></span><br><span class="line">	<span class="type">uint32_t</span>	init_module;	<span class="comment">/* index into the module table that */</span></span><br><span class="line">				                <span class="comment">/*  the init routine is defined in */</span></span><br><span class="line">	<span class="type">uint32_t</span>	reserved1;</span><br><span class="line">	<span class="type">uint32_t</span>	reserved2;</span><br><span class="line">	<span class="type">uint32_t</span>	reserved3;</span><br><span class="line">	<span class="type">uint32_t</span>	reserved4;</span><br><span class="line">	<span class="type">uint32_t</span>	reserved5;</span><br><span class="line">	<span class="type">uint32_t</span>	reserved6;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>init_address</code>
<ul>
<li>表示构建函数在虚拟内存中的地址。</li>
</ul></li>
<li><code>init_module</code>
<ul>
<li>表示包含构建函数的模块在模块表中的索引。</li>
</ul></li>
</ul>
<p>当使用 <code>-init</code>
选项指定一个共享库构建函数时，静态链接器会添加一个
<code>LC_ROUTINES</code> 命令。</p>
<h2 id="sub_framework_command">sub_framework_command</h2>
<p><code>sub_framework_command</code> 加载命令用于指定 subframework
所属的 umbrella framework。<code>sub_framework_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sub_framework_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		    <span class="comment">/* LC_SUB_FRAMEWORK */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	    <span class="comment">/* includes umbrella string */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span> 	<span class="title">umbrella</span>;</span>	<span class="comment">/* the umbrella framework name */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>umbrella</code>
<ul>
<li>表示此文件所属的 umbrella framework 的名称。</li>
</ul></li>
</ul>
<h2 id="sub_umbrella_command">sub_umbrella_command</h2>
<p><code>sub_umbrella_command</code> 加载命令用于指定 framework 的一个
subumbrella。与 subframework 不同，任何客户端都可以链接到一个
subumbrella。</p>
<p><code>sub_umbrella_command</code> 的数据结构定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sub_umbrella_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		        <span class="comment">/* LC_SUB_UMBRELLA */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	        <span class="comment">/* includes sub_umbrella string */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span> 	<span class="title">sub_umbrella</span>;</span>	<span class="comment">/* the sub_umbrella framework name */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>sub_umbrella</code>
<ul>
<li><code>lc_str</code> 类型的数据结构。用于指定 subumbrella
的名称。</li>
</ul></li>
</ul>
<h2 id="sub_library_command">sub_library_command</h2>
<p>指定此 framework 的一个 sublibrary，并将此 framework 标记为 umbrella
framework。与 subframework 不同，任何客户端都可以链接到一个
sublibrary。</p>
<p><code>sub_library_command</code> 的数据结构定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sub_library_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		        <span class="comment">/* LC_SUB_LIBRARY */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	        <span class="comment">/* includes sub_library string */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span> 	<span class="title">sub_library</span>;</span>	<span class="comment">/* the sub_library name */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>sub_library</code>
<ul>
<li><code>lc_str</code> 类型的数据结构。用于指定此文件所属的 sublibrary
的名称。</li>
</ul></li>
</ul>
<h2 id="sub_client_command">sub_client_command</h2>
<p><code>sub_client_command</code> 加载命令用于指定允许链接到此
subframework 的文件的名称。否则，需要该文件链接到该文件所在的 umbrella
framework。</p>
<p><code>sub_client_command</code> 的数据结构如下所示：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sub_client_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SUB_CLIENT */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* includes client string */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">lc_str</span> 	<span class="title">client</span>;</span>		<span class="comment">/* the client name */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>client</code>
<ul>
<li><code>lc_str</code> 类型的数据结构。用于指定允许链接到此 library
的客户端的名称。</li>
</ul></li>
</ul>
<p>如果在调用 <code>ld</code> 时带上
<code>-allowable_client &lt;name&gt;</code> 选项，其中
<code>&lt;name&gt;</code> 可以是一个 framework 的安装名称，也可以是一个
bundle 的客户端名称，那么 <code>ld</code> 工具会在产物中生成一个
<code>sub_client_command</code> 加载命令。</p>
<h2 id="symtab_command">symtab_command</h2>
<p><code>symtab_command</code>
加载命令用于描述符号表的数据结构以及位置和大小信息。<code>symtab_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmd;		<span class="comment">/* LC_SYMTAB */</span></span><br><span class="line">	<span class="type">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct symtab_command) */</span></span><br><span class="line">	<span class="type">uint32_t</span>	symoff;		<span class="comment">/* symbol table offset */</span></span><br><span class="line">	<span class="type">uint32_t</span>	nsyms;		<span class="comment">/* number of symbol table entries */</span></span><br><span class="line">	<span class="type">uint32_t</span>	stroff;		<span class="comment">/* string table offset */</span></span><br><span class="line">	<span class="type">uint32_t</span>	strsize;	<span class="comment">/* string table size in bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>symoff</code>
<ul>
<li>指定符号表表项在文件中的起始位置。<strong>符号表是一组
<code>nlist</code> 数据结构组成的一个表</strong>。</li>
</ul></li>
<li><code>nsyms</code>
<ul>
<li>指定符号表中的表项数量。</li>
</ul></li>
<li><code>stroff</code>
<ul>
<li>指定字符串表在文件中的起始位置。</li>
</ul></li>
<li><code>strsize</code>
<ul>
<li>指定字符串表的大小。单位为字节。</li>
</ul></li>
</ul>
<h3 id="nlist">nlist</h3>
<p><code>nlist</code> 是表示符号表中的表项的数据结构。<code>nlist</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlist</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LP64__</span></span><br><span class="line">		<span class="type">char</span> *n_name;	<span class="comment">/* for use when in-core */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="type">uint32_t</span> n_strx;	<span class="comment">/* index into the string table */</span></span><br><span class="line">	&#125; n_un;</span><br><span class="line">	<span class="type">uint8_t</span> n_type;		<span class="comment">/* type flag, see below */</span></span><br><span class="line">	<span class="type">uint8_t</span> n_sect;		<span class="comment">/* section number or NO_SECT */</span></span><br><span class="line">	<span class="type">int16_t</span> n_desc;		<span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line">	<span class="type">uint32_t</span> n_value;	<span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>u_un</code>
<ul>
<li>保存了指向字符串表的索引，<code>n_str</code>。如果希望指定一个空字符串（""），可以将字段设置为
0。联合体中的 <code>n_name</code> 字段并不会用在 Mach-O 文件中。</li>
</ul></li>
<li><code>n_type</code>
<ul>
<li>一个字节值，包含使用四个位掩码访问的数据。
<ul>
<li><code>N_STAB</code>（0xE0）：如果设置了这 3
位，则表示该符号是符号调试表（stab）表项。在这种情况下，整个
<code>n_type</code> 字段都被解释为 stab 值。</li>
<li><code>N_PEXT</code>（0x10）：如果设置了此位，则表示该符号被标记为具有有限的全局作用域。静态链接器处理该文件时会将每个设置了
<code>N_PEXT</code> 位的符号清除 <code>N_EXT</code> 位（<code>ld</code>
的 <code>-keep_private_externs</code> 选项关闭了此行为）。对于 OS X
GCC，我们可以使用 <code>__private_extern__</code>
方法属性来设置此位。</li>
<li><code>N_TYPE</code>（0x0E）：这些位定义了符号的类型。</li>
<li><code>N_EXT</code>（0x01）：如果设置了这 3
位，则表示该符号是一个外部符号，该符号可以在此文件外部定义，也可以在此文件中定义并可以被外部文件引用。</li>
</ul></li>
<li>上述提到的 <code>N_TYPE</code> 字段包含以下这些值：
<ul>
<li><code>N_UNDF</code>（0x0）：表示符号未定义。未定义符号是指在此模块中引用但是在其他模块中定义的符号。此时，<code>n_sect</code>
字段为 <code>NO_SECT</code>。</li>
<li><code>N_ABS</code>（0x2）：表示符号是绝对的。链接器不会修改绝对符号的值。此时，<code>n_sect</code>
字段为 <code>NO_SECT</code>。</li>
<li><code>N_SECT</code>（0xE）：表示符号定义在 <code>n_sect</code>
所指定的 section 中。</li>
<li><code>N_PBUD</code>（0xC）：表示符号未定义，并且镜像为该符号使用了一个预绑定的值。此时，<code>n_sect</code>
字段为 <code>NO_SECT</code>。</li>
<li><code>N_INDR</code>（0xA）：表示符号的定义与另一个符号相同。<code>n_value</code>
字段是一个指向字符串表的索引，用于指定另一个符号的名称。链接该符号时，此符号与另一个符号具有相同定义的类型和值。</li>
</ul></li>
</ul></li>
<li><code>n_sect</code>
<ul>
<li>表示 section 的编号，在对应 section
中可以找到该符号；如果该字段的值为
<code>NO_SECT</code>，则表示在该镜像中找不到该符号。section 在 segment
中是按顺序排列的，从 1 开始连续编号。</li>
</ul></li>
<li><code>n_desc</code>
<ul>
<li>一个 16 位的值，为非稳定符号提供关于该符号性质的附加信息。可以使用
<code>REFERENCE_TYPE</code>（0xF）掩码来访问其值。值的定义有以下这些：
<ul>
<li><code>REFERENCE_FLAG_UNDEFINED_NON_LAZY</code>（0x0）：表示该符号引用了外部非惰性（数据）符号。</li>
<li><code>REFERENCE_FLAG_UNDEFINED_LAZY</code>（0x1）：表示该符号引用了外部惰性符号。比如一个函数调用。</li>
<li><code>REFERENCE_FLAG_DEFINED</code>（0x2）：表示符号定义在本模块内。</li>
<li><code>REFERENCE_FLAG_PRIVATE_DEFINED</code>（0x3）：表示符号定义在本模块内，并且只对本共享库内的模块可见。</li>
<li><code>REFERENCE_FLAG_PRIVATE_UNDEFINED_NON_LAZY</code>（0x4）：表示符号定义在了此文件中的其他模块内，是一个非惰性（数据）符号，并且只对本共享库内的模块可见。</li>
<li><code>REFERENCE_FLAG_PRIVATE_UNDEFINED_LAZY</code>（0x5）：表示符号定义在了此文件中的其他模块内，是一个惰性（函数）符号，并且只对本共享库内的模块可见。</li>
</ul></li>
<li>掩码以外的位的值的定义有以下这些：
<ul>
<li><code>REFERENCED_DYNAMICALLY</code>（0x10）：对于被动态加载器 API
（如：<code>dlsym</code>、<code>NSLookupSymbolInImage</code>）引用的已定义符号，或者该位必须被设置。<code>strip</code>
工具使用该位来避免删除必须存在的符号：如果符号设置了该位，则
<code>strip</code> 不会删除它。</li>
<li><code>N_DESC_DISCARDED</code>（0x20）：在一个完全链接的镜像中，动态链接器会在运行时用到该位。因此，不要在完全链接的图像中设置此位。</li>
<li><code>N_NO_DEAD_STRIP</code>（0x20）：当在一个可重定位目标文件（文件类型为
<code>MH_OBJECT</code>）中对一个已定义符号进行设置时，表示静态链接器用于不会对符号进行
dead-strip 处理。</li>
<li><code>N_WEAK_REF</code>（0x40）：表示此未定义符号是一个弱引用。如果动态链接器找不到该符号的定义，那么将会符号地址位置为
0。静态链接器在给定合适的弱链接标志的情况下会设置此符号。</li>
<li><code>N_WEAK_DEF</code>（0x80）：表示此符号是一个弱定义。如果静态链接器或动态链接器为该符号找到了另一个（非弱）定义，那么弱定义会被忽略。只有在已合并的
section 中的符号可以被标记为弱定义。</li>
</ul></li>
<li>如果文件是一个两级命名空间镜像（即，如果设置了
<code>mach_header</code> 的 <code>MH_TWOLEVEL</code> 标志位），那么
<code>n_desc</code> 的高 8 位则指向未定义符号的定义所位于的
library。使用 <code>GET_LIBRARY_ORDINAL 宏</code> 来读取此值，使用
<code>SET_LIBRARY_ORIDINAL</code> 宏来设置此值。0 表示指定当前镜像。1 到
253 则是根据此文件中的 <code>LC_LOAD_COMMAND</code> 加载命令的顺序指定
library 的编号。254
用于会被动态查找的未定义的符号。对于能够从可执行程序中加载符号的插件，会将其链接至
255，从而指定可执行镜像。对于扁平命名空间镜像，高 8 位必须为 0。</li>
</ul></li>
<li><code>n_value</code>
<ul>
<li>即符号的值。符号表表项的类型（<code>n_type</code>
字段指定）不同，那么值的形式也不同。对于 <code>N_SECT</code>
符号类型，<code>n_value</code> 是符号的地址。</li>
</ul></li>
</ul>
<p>公共符号必须是 <code>N_UNDF</code> 类型，并且必须设置
<code>N_EXT</code> 位。公共符号的 <code>n_value</code>
是符号的数据的大小（以字节为单位）。在 C
语言中，公共符号是在此文件中声明但未初始化的变量。公共符号只能出现在
<code>MH_OBJECT</code> 类型的 Mach-O 文件中。</p>
<h2 id="dysymtab_command">dysymtab_command</h2>
<p><code>dysymtab_command</code>
加载命令描述了用于动态链接的符号表的各部分的大小和位置。<code>dysymtab_command</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> cmd;	        <span class="comment">/* LC_DYSYMTAB */</span></span><br><span class="line">    <span class="type">uint32_t</span> cmdsize;	    <span class="comment">/* sizeof(struct dysymtab_command) */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> ilocalsym; 	<span class="comment">/* index to local symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> nlocalsym;	    <span class="comment">/* number of local symbols */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> iextdefsym;    <span class="comment">/* index to externally defined symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> nextdefsym;    <span class="comment">/* number of externally defined symbols */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> iundefsym;	    <span class="comment">/* index to undefined symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> nundefsym;	    <span class="comment">/* number of undefined symbols */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> tocoff;	    <span class="comment">/* file offset to table of contents */</span></span><br><span class="line">    <span class="type">uint32_t</span> ntoc;	        <span class="comment">/* number of entries in table of contents */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> modtaboff;	    <span class="comment">/* file offset to module table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nmodtab;	    <span class="comment">/* number of module table entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> extrefsymoff;	<span class="comment">/* offset to referenced symbol table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nextrefsyms;	<span class="comment">/* number of referenced symbol table entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> indirectsymoff;<span class="comment">/* file offset to the indirect symbol table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nindirectsyms; <span class="comment">/* number of indirect symbol table entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> extreloff;	    <span class="comment">/* offset to external relocation entries */</span></span><br><span class="line">    <span class="type">uint32_t</span> nextrel;	    <span class="comment">/* number of external relocation entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> locreloff;	    <span class="comment">/* offset to local relocation entries */</span></span><br><span class="line">    <span class="type">uint32_t</span> nlocrel;	    <span class="comment">/* number of local relocation entries */</span></span><br><span class="line">&#125;;	</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>ilocalsym</code>
<ul>
<li>指定本地符号组中第一个符号的索引。</li>
</ul></li>
<li><code>nlocalsym</code>
<ul>
<li>指定本地符号组中所有符号的数量。</li>
</ul></li>
<li><code>iextdefsym</code>
<ul>
<li>指定已定义的外部符号组中第一个符号的索引。</li>
</ul></li>
<li><code>nextdefsym</code>
<ul>
<li>指定已定义的外部符号组中所有符号的数量。</li>
</ul></li>
<li><code>iundefsym</code>
<ul>
<li>指定未定义的外部符号组中第一个符号的索引。</li>
</ul></li>
<li><code>nundefsym</code>
<ul>
<li>指定未定义的外部符号组中所有符号的数量。</li>
</ul></li>
<li><code>tocoff</code>
<ul>
<li>指定内容数据表在文件中的偏移。</li>
</ul></li>
<li><code>ntoc</code>
<ul>
<li>指定内容数据表的表项数量</li>
</ul></li>
<li><code>modtaboff</code>
<ul>
<li>指定模块表数据在文件中的偏移。</li>
</ul></li>
<li><code>nmodtab</code>
<ul>
<li>指定模块表的表项数量。</li>
</ul></li>
<li><code>extrefsymoff</code>
<ul>
<li>指定外部引用表数据在文件中的偏移。</li>
</ul></li>
<li><code>nextrefsyms</code>
<ul>
<li>指定外部引用表数据的表项数量。</li>
</ul></li>
<li><code>indirectsymoff</code>
<ul>
<li>指定间接符号表数据在文件中的偏移。</li>
</ul></li>
<li><code>nindirectsyms</code>
<ul>
<li>指定间接符号表的表项数量。</li>
</ul></li>
<li><code>extreloff</code>
<ul>
<li>指定外部重定位表数据在文件中的偏移。</li>
</ul></li>
<li><code>nextrel</code>
<ul>
<li>指定外部重定位表的表项数量。</li>
</ul></li>
<li><code>locrelloff</code>
<ul>
<li>指定本地重定位表数据在文件中的偏移。</li>
</ul></li>
<li><code>nlocrel</code>
<ul>
<li>指定本地重定位表的表项数量。</li>
</ul></li>
</ul>
<p><code>LC_DYSYMTAB</code>
加载命令包含符号表的一组索引和一组文件偏移量，这些文件偏移量定义了其他几个表的位置。文件中未使用的表的字段应设置为
0。</p>
<h3 id="dylib_table_of_contents">dylib_table_of_contents</h3>
<p><code>dylib_table_of_contents</code>
用于描述一个动态共享库内容表的表项。<code>dylib_table_of_contents</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib_table_of_contents</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> symbol_index;	<span class="comment">/* the defined external symbol (index into the symbol table) */</span></span><br><span class="line">    <span class="type">uint32_t</span> module_index;	<span class="comment">/* index into the module table this symbol is defined in */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>symbol_index</code>
<ul>
<li>一个符号表表项的索引，该表项引用了这个已定义的外部符号。</li>
</ul></li>
<li><code>module_index</code>
<ul>
<li>一个模块表表项的索引，表示这个已定义的外部符号所在的模块。</li>
</ul></li>
</ul>
<h3 id="dylib_module">dylib_module</h3>
<p><code>dylib_module</code>
用于描述一个动态共享库的模块表表项。<code>dylib_module</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib_module</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> module_name;	<span class="comment">/* the module name (index into string table) */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> iextdefsym;	<span class="comment">/* index into externally defined symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> nextdefsym;	<span class="comment">/* number of externally defined symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> irefsym;		<span class="comment">/* index into reference symbol table */</span></span><br><span class="line">    <span class="type">uint32_t</span> nrefsym;		<span class="comment">/* number of reference symbol table entries */</span></span><br><span class="line">    <span class="type">uint32_t</span> ilocalsym;		<span class="comment">/* index into symbols for local symbols */</span></span><br><span class="line">    <span class="type">uint32_t</span> nlocalsym;		<span class="comment">/* number of local symbols */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> iextrel;		<span class="comment">/* index into external relocation entries */</span></span><br><span class="line">    <span class="type">uint32_t</span> nextrel;		<span class="comment">/* number of external relocation entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> iinit_iterm;	<span class="comment">/* low 16 bits are the index into the init section, high 16 bits are the index into the term section */</span></span><br><span class="line">    <span class="type">uint32_t</span> ninit_nterm;	<span class="comment">/* low 16 bits are the number of init section entries, high 16 bits are the number of term section entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span>			    <span class="comment">/* for this module address of the start of */</span></span><br><span class="line">	objc_module_info_addr;  <span class="comment">/*  the (__OBJC,__module_info) section */</span></span><br><span class="line">    <span class="type">uint32_t</span>			    <span class="comment">/* for this module size of */</span></span><br><span class="line">	objc_module_info_size;	<span class="comment">/*  the (__OBJC,__module_info) section */</span></span><br><span class="line">&#125;;	</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>module_name</code>
<ul>
<li>一个字符串表的表项索引，该表项描述了这个模块的名称。</li>
</ul></li>
<li><code>iextdefsym</code>
<ul>
<li>表示该模块的第一个已定义外部符号在符号表中的索引。</li>
</ul></li>
<li><code>nextdefsym</code>
<ul>
<li>表示该模块的所有已定义外部符号的数量。</li>
</ul></li>
<li><code>irefsym</code>
<ul>
<li>表示该模块在外部引用表中的第一个表项的索引。</li>
</ul></li>
<li><code>nrefsym</code>
<ul>
<li>表示该模块在外部引用表中的占有表项的数量。</li>
</ul></li>
<li><code>ilocalsym</code>
<ul>
<li>表示该模块的第一个本地符号在符号表中的索引。</li>
</ul></li>
<li><code>nlocalsym</code>
<ul>
<li>表示该模块的所有本地符号的数量。</li>
</ul></li>
<li><code>iexterel</code>
<ul>
<li>表示该模块在外部重定位表中的第一个表项的索引。</li>
</ul></li>
<li><code>nextrel</code>
<ul>
<li>表示该模块在外部重定位表中占有表项的数量。</li>
</ul></li>
<li><code>iinit_iterm</code>
<ul>
<li>指定了模块构造 section 的索引（低 16 位）；指定了模块析构 section
的索引（高 16 位）。</li>
</ul></li>
<li><code>ninit_nterm</code>
<ul>
<li>指定了模块构造 section 中的指针数量（低 16 位）；指定了模块析构
section 中的指针数量（高 16 位）。</li>
</ul></li>
<li><code>objc_module_info_addr</code>
<ul>
<li>表该模块数据部分的起始静态链接地址，位于 <code>__module_info</code>
section <code>__OBJC</code> segment。</li>
</ul></li>
<li><code>objc_module_info_size</code>
<ul>
<li>表示 <code>__OBJC</code> segment 的 <code>__module_info</code>
section 使用该模块的数据的字节数。</li>
</ul></li>
</ul>
<h3 id="dylib_reference">dylib_reference</h3>
<p><code>dylib_reference</code>
为共享库中的模块提供的外部引用表项定义属性。<code>dylib_reference</code>
的数据结构定义如下： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib_reference</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> isym:<span class="number">24</span>,	<span class="comment">/* index into the symbol table */</span></span><br><span class="line">    		  flags:<span class="number">8</span>;	<span class="comment">/* flags to indicate the type of reference */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>字段说明</strong></p>
<ul>
<li><code>isym</code>
<ul>
<li>表示被引用符号在符号表中的索引。</li>
</ul></li>
<li><code>flags</code>
<ul>
<li>用于表示引用的类型。</li>
</ul></li>
</ul>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a
href="https://studfile.net/preview/2082911/">Mach-O_File_Format.pdf</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Bao Chuquan 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="Bao Chuquan 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Mach-O/" rel="tag"># Mach-O</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/08/24/rxswift-core-implement/" rel="prev" title="RxSwift 核心实现原理">
                  <i class="fa fa-angle-left"></i> RxSwift 核心实现原理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/10/02/zsh-completion-tutorial/" rel="next" title="Zsh 自动补全脚本入门">
                  Zsh 自动补全脚本入门 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">true</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
  <div>
     <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备16031766号-1</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://vercel.chuquan.me","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"(发表评论)","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"dark":"body.darkmode--activated","visitor":true,"comment_count":true,"requiredFields":["nick"],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2020/09/14/mach-o-format/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: false,
  label: '🌓',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script src="/live2dwlib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dwassets/tororo.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":-15,"vOffset":-15},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>
