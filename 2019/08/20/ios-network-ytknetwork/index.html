<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/chu.icon">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/chu.icon">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chuquan.me","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="注意：在阅读本文之前建议先阅读《iOS 网络——NSURLSession》和《iOS 网络——AFNetworking》。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 网络(3)——YTKNetwork">
<meta property="og:url" content="http://chuquan.me/2019/08/20/ios-network-ytknetwork/index.html">
<meta property="og:site_name" content="楚权的世界">
<meta property="og:description" content="注意：在阅读本文之前建议先阅读《iOS 网络——NSURLSession》和《iOS 网络——AFNetworking》。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-08-20T15:57:44.000Z">
<meta property="article:modified_time" content="2023-09-16T12:24:21.632Z">
<meta property="article:author" content="Bao Chuquan">
<meta property="article:tag" content="源码解读">
<meta property="article:tag" content="YTKNetwork">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chuquan.me/2019/08/20/ios-network-ytknetwork/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://chuquan.me/2019/08/20/ios-network-ytknetwork/","path":"2019/08/20/ios-network-ytknetwork/","title":"iOS 网络(3)——YTKNetwork"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>iOS 网络(3)——YTKNetwork | 楚权的世界</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?030cf08d5b27d756fa9aeecb1130fe13"></script>






<link rel="dns-prefetch" href="https://vercel.chuquan.me">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="楚权的世界" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="headband"></div>
  <a href="https://github.com/baochuquan"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">楚权的世界</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Seek the wonder of life.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ytknetwork-%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">YTKNetwork 概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ytknetwork-%E6%9E%B6%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">YTKNetwork 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ytknetwork-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="nav-number">2.1.</span> <span class="nav-text">YTKNetwork 核心功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ytkbaserequest"><span class="nav-number">2.1.1.</span> <span class="nav-text">YTKBaseRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ytknetworkconfig"><span class="nav-number">2.1.2.</span> <span class="nav-text">YTKNetworkConfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ytknetworkagent"><span class="nav-number">2.1.3.</span> <span class="nav-text">YTKNetworkAgent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%B9%B6%E6%89%A7%E8%A1%8C%E8%AF%B7%E6%B1%82"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">添加并执行请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E5%9B%9E%E8%B0%83"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">完成回调</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E4%BB%BB%E5%8A%A1%E4%B8%8E%E7%BC%93%E5%AD%98"><span class="nav-number">2.1.3.4.</span> <span class="nav-text">下载任务与缓存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ytknetwork-%E9%93%BE%E5%BC%8F%E8%AF%B7%E6%B1%82"><span class="nav-number">2.2.</span> <span class="nav-text">YTKNetwork 链式请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ytkchainrequest"><span class="nav-number">2.2.1.</span> <span class="nav-text">YTKChainRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ytkchainrequestagent"><span class="nav-number">2.2.2.</span> <span class="nav-text">YTKChainRequestAgent</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ytknetwork-%E6%89%B9%E9%87%8F%E8%AF%B7%E6%B1%82"><span class="nav-number">2.3.</span> <span class="nav-text">YTKNetwork 批量请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ytkrequest"><span class="nav-number">2.3.1.</span> <span class="nav-text">YTKRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%9B%AE%E5%BD%95"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">缓存目录</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bao Chuquan"
      src="/images/SlamDunk.png">
  <p class="site-author-name" itemprop="name">Bao Chuquan</p>
  <div class="site-description" itemprop="description">积累，沉淀，吸收，转换</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">148</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">362</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/baochuquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;baochuquan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:baochuquan@gmail.com" title="E-Mail → mailto:baochuquan@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/baochuquan" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;baochuquan" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Baochuquan" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Baochuquan" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chuquan.me/2019/08/20/ios-network-ytknetwork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/SlamDunk.png">
      <meta itemprop="name" content="Bao Chuquan">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="楚权的世界">
      <meta itemprop="description" content="积累，沉淀，吸收，转换">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="iOS 网络(3)——YTKNetwork | 楚权的世界">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS 网络(3)——YTKNetwork
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-20 23:57:44" itemprop="dateCreated datePublished" datetime="2019-08-20T23:57:44+08:00">2019-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-16 20:24:21" itemprop="dateModified" datetime="2023-09-16T20:24:21+08:00">2023-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2019/08/20/ios-network-ytknetwork/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2019/08/20/ios-network-ytknetwork/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>注意：在阅读本文之前建议先阅读<a
href="http://chuquan.me/2019/07/21/ios-network-nsurlsession/">《iOS
网络——NSURLSession》</a>和<a
href="http://chuquan.me/2019/08/06/ios-network-afnetworking/">《iOS
网络——AFNetworking》</a>。</p>
</blockquote>
<span id="more"></span>
<p>在<a
href="http://chuquan.me/2019/08/06/ios-network-afnetworking/">《iOS
网络——AFNetworking》</a>一文中我们介绍了基于 <code>NSURLSession</code>
进行封装的 AFNetworking 的核心功能原理。本文，我们进一步介绍基于
AFNetworking 进行封装的 YTKNetwork 开源框架。本文，我们通过阅读
YTKNetwork 源代码（版本号：<code>2.0.4</code>）。</p>
<h1 id="ytknetwork-概述">YTKNetwork 概述</h1>
<p>YTKNetwork 是猿题库技术团队开源的一个网络请求框架，内部封装了
AFNetworking。YTKNetwork 实现了一套高层级的
API，提供更高层次的网络访问抽象。目前，猿题库公司的所有产品的 iOS
客户端都使用了
YTKNetwork，包括：猿题库、小猿搜题、猿辅导、小猿口算、斑马系列等。</p>
<h1 id="ytknetwork-架构">YTKNetwork 架构</h1>
<p>YTKNetwork 开源框架主要包含 3 个部分：</p>
<ul>
<li>YTKNetwork 核心功能</li>
<li>YTKNetwork 链式请求</li>
<li>YTKNetwork 批量请求</li>
</ul>
<p>其中，链式请求和批量请求都是基于 YTKNetwork
的核心功能实现的。下面我们分别进行介绍。</p>
<h2 id="ytknetwork-核心功能">YTKNetwork 核心功能</h2>
<p><img
src="https://chuquan-public-r-001.oss-cn-shanghai.aliyuncs.com/sketch-images/ytknetwork-overview.png?x-oss-process=image/resize,w_800" /></p>
<p>上图所示为 YTKNetwork 核心功能的类的引用关系示意图。YTKNetwork
核心功能的基本思想是：</p>
<ul>
<li><strong>把每一个网络请求封装成一个对象，每个请求对象继承自
<code>YTKBaseRequest</code> 类</strong>。</li>
<li><strong>使用 <code>YTKNetworkAgent</code> 单例对象持有一个
<code>AFHTTPSessionManager</code> 对象来管理所有请求对象</strong>。</li>
</ul>
<p>YTKNetwork 核心功能主要涉及到 3 个类：</p>
<ul>
<li><code>YTKBaseRequest</code></li>
<li><code>YTKNetworkConfig</code></li>
<li><code>YTKNetworkAgent</code></li>
</ul>
<p>下面我们分别进行介绍。</p>
<h3 id="ytkbaserequest">YTKBaseRequest</h3>
<p><code>YTKBaseRequest</code>
类用于表示一个请求对象，它提供了一系列属性来充分表示一个网络请求。我们可以看一下它所定义的属性：
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKBaseRequest</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">/// 请求相关属性</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSURLSessionTask</span> *requestTask;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSURLRequest</span> *currentRequest;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSURLRequest</span> *originalRequest;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSHTTPURLResponse</span> *response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 响应相关属性</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInteger</span> responseStatusCode;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">NSDictionary</span> *responseHeaders;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">NSData</span> *responseData;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *responseString;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="type">id</span> responseObject;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="type">id</span> responseJSONObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 异常</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">NSError</span> *error;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 状态</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">getter</span>=isCancelled) <span class="type">BOOL</span> cancelled;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">getter</span>=isExecuting) <span class="type">BOOL</span> executing;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 标识符，默认是 0</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> tag;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 附加信息，默认是 nil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSDictionary</span> *userInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代理</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span>&lt;YTKRequestDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 成功/失败回调</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) YTKRequestCompletionBlock successCompletionBlock;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) YTKRequestCompletionBlock failureCompletionBlock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用于在 POST 请求时构建 HTTP 主体。默认是 nil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) AFConstructingBlock constructingBodyBlock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用于下载任务时指定本地下载路径</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *resumableDownloadPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用于跟踪下载进度的回调</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) AFURLSessionTaskProgressBlock resumableDownloadProgressBlock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求优先级</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) YTKRequestPriority requestPriority;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// YTKRequestAccessory 是一个协议，声明了三个方法，允许开发者分别在请求执行的三个阶段(start、willStop、didStop)调用。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="type">id</span>&lt;YTKRequestAccessory&gt;&gt; *requestAccessories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>事实上，<code>YTKBaseRequest</code> 类就是围绕
<code>NSURLSessionTask</code> 类进行封装的， <code>requestTask</code>
是它最重要的属性。<code>YTKBaseRequest</code> 的其他多个属性都源自于
<code>requestTask</code> 的属性。如：</p>
<ul>
<li><code>currentRequest</code>：即
<code>requestTask.currentRequest</code></li>
<li><code>originalRequest</code>：即
<code>requestTask.originalRequest</code></li>
<li><code>response</code>：即 <code>requestTask.response</code></li>
<li><code>responseHeaders</code>：即
<code>requestTask.allHeaderFields</code></li>
<li><code>responseStatusCode</code>：即
<code>requestTask.statusCode</code></li>
</ul>
<p><code>YTKBaseRequest</code>
提供了高层级的网络抽象，体现在提供了一些高层级的配置方法，并允许用户通过覆写这些方法来进行自定义配置。一些常用的配置方法包括如下：
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Base URL，因为一个应用程序中的网络请求的 BaseURL 几乎都是相同的。</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)baseUrl &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求的 URL 路径</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)requestUrl &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 网络请求的超时间隔。默认 60 秒</span></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)requestTimeoutInterval &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">60</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HTTP 请求方法。默认是 GET</span></span><br><span class="line">- (YTKRequestMethod)requestMethod &#123;</span><br><span class="line">    <span class="keyword">return</span> YTKRequestMethodGET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求序列化器类型。默认是 HTTP</span></span><br><span class="line">- (YTKRequestSerializerType)requestSerializerType &#123;</span><br><span class="line">    <span class="keyword">return</span> YTKRequestSerializerTypeHTTP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 响应序列化器类型。默认是 JSON</span></span><br><span class="line">- (YTKResponseSerializerType)responseSerializerType &#123;</span><br><span class="line">    <span class="keyword">return</span> YTKResponseSerializerTypeJSON;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求参数对象，会根据配置的请求序列化器进行编码。</span></span><br><span class="line">- (<span class="type">id</span>)requestArgument &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否允许蜂窝网络。默认 YES</span></span><br><span class="line">- (<span class="type">BOOL</span>)allowsCellularAccess &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否使用 CDN。默认 NO</span></span><br><span class="line">- (<span class="type">BOOL</span>)useCDN &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// CDN URL。根据 useCDN 决定是否使用。</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)cdnUrl &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>关于 <code>YTKBaseRequest</code>
对象的执行，它也提供了几个简单的方法以供开发者使用，如下所示。通过
<code>start</code> 方法，我们可以发现 <code>YTKBaseRequest</code>
被加入到了 <code>YTKNetworkAgent</code> 单例中。可见
<code>YTKNetworkAgent</code> 管理了多个 <code>YTKBaseRequest</code>
对象。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// YTKBaseRequest 开始执行</span></span><br><span class="line">- (<span class="type">void</span>)start &#123;</span><br><span class="line">    <span class="comment">// 执行 YTKRequestAccessory 协议定义的 requestWillStart: 方法。</span></span><br><span class="line">    [<span class="keyword">self</span> toggleAccessoriesWillStartCallBack];</span><br><span class="line">    <span class="comment">// 将请求对象加入 YTKNetworkAgent 单例</span></span><br><span class="line">    [[YTKNetworkAgent sharedAgent] addRequest:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// YTKBaseRequest 停止执行</span></span><br><span class="line">- (<span class="type">void</span>)stop &#123;</span><br><span class="line">    <span class="comment">// 执行 YTKRequestAccessory 协议定义的 requestWillStop: 方法。</span></span><br><span class="line">    [<span class="keyword">self</span> toggleAccessoriesWillStopCallBack];</span><br><span class="line">    <span class="keyword">self</span>.delegate = <span class="literal">nil</span>;</span><br><span class="line">    [[YTKNetworkAgent sharedAgent] cancelRequest:<span class="keyword">self</span>];</span><br><span class="line">    <span class="comment">// 执行 YTKRequestAccessory 协议定义的 requestDidStop: 方法。</span></span><br><span class="line">    [<span class="keyword">self</span> toggleAccessoriesDidStopCallBack];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 一个便利方法。执行 YTKBaseRequest。</span></span><br><span class="line">- (<span class="type">void</span>)startWithCompletionBlockWithSuccess:(YTKRequestCompletionBlock)success</span><br><span class="line">                                    failure:(YTKRequestCompletionBlock)failure &#123;</span><br><span class="line">    [<span class="keyword">self</span> setCompletionBlockWithSuccess:success failure:failure];</span><br><span class="line">    [<span class="keyword">self</span> start];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ytknetworkconfig">YTKNetworkConfig</h3>
<p><code>YTKNetworkConfig</code> 是用于 <code>YTKNetworkAgent</code>
初始化的配置对象，是一个 <strong>单例</strong>。</p>
<p><code>YTKNetworkConfig</code> 主要包含以下属性： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKNetworkConfig</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求的 Base URL。默认是 &quot;&quot;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *baseUrl;</span><br><span class="line"></span><br><span class="line"><span class="comment">///  CDN URL. 默认是 &quot;&quot;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *cdnUrl;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// URL 过滤器。YTKUrlFilterProtocol 声明的 filterUrl:withRequest: 方法会返回最终被使用的 URL</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="type">id</span>&lt;YTKUrlFilterProtocol&gt;&gt; *urlFilters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 缓存路径过滤器。YTKCacheDirPathFilterProtocol 声明的 filterCacheDirPath:withRequest: 方法会返回最终被使用的缓存路径。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="type">id</span>&lt;YTKCacheDirPathFilterProtocol&gt;&gt; *cacheDirPathFilters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 安全策略。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFSecurityPolicy *securityPolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否打印调试日志信息。默认是 NO</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> debugLogEnabled;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 会话配置对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSessionConfiguration</span>* sessionConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p><code>YTKNetworkConfig</code> 持有了一个
<code>NSURLSessionConfiguration</code> 类型的属性
<code>sessionConfiguration</code>，用于 <code>YTKNetworkAgent</code>
中初始化 <code>AFHTTPSessionManager</code>（本质上是用于初始化
<code>NSURLSession</code>）。</p>
<h3 id="ytknetworkagent">YTKNetworkAgent</h3>
<p><code>YTKNetworkAgent</code>
的内部结构如下图所示。下面我们将以该图为指导进行介绍。</p>
<p><img
src="https://chuquan-public-r-001.oss-cn-shanghai.aliyuncs.com/sketch-images/ytknetwork-ytknetworkagent.png?x-oss-process=image/resize,w_800" /></p>
<h4 id="初始化">初始化</h4>
<p><code>YTKNetworkAgent</code> 初始化过程会使用
<code>YTKNetworkConfig</code>
单例对象（配置对象）。使用配置对象的会话配置对象
<code>sessionConfiguration</code> 初始化会话管理器
<code>AFHTTPSessionManager</code>。</p>
<p><code>YTKNetwork</code> 框架默认只能使用 <code>YTKNetworkAgent</code>
单例对象。</p>
<h4 id="添加并执行请求">添加并执行请求</h4>
<p><code>YTKNetworkAgent</code> 提供了 <code>addRequest:</code>
方法来添加并执行请求对象。我们可以来看一下其内部实现。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)addRequest:(YTKBaseRequest *)request &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span> * __autoreleasing requestSerializationError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化请求对象的关键属性 requestTask，即任务对象</span></span><br><span class="line">    <span class="built_in">NSURLRequest</span> *customUrlRequest= [request buildCustomUrlRequest];</span><br><span class="line">    <span class="keyword">if</span> (customUrlRequest) &#123;</span><br><span class="line">        __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">        dataTask = [_manager dataTaskWithRequest:customUrlRequest completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="type">id</span>  _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">            <span class="comment">// 完成回调</span></span><br><span class="line">            [<span class="keyword">self</span> handleRequestResult:dataTask responseObject:responseObject error:error];</span><br><span class="line">        &#125;];</span><br><span class="line">        request.requestTask = dataTask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 默认方式</span></span><br><span class="line">        request.requestTask = [<span class="keyword">self</span> sessionTaskForRequest:request error:&amp;requestSerializationError];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求序列化异常处理</span></span><br><span class="line">    <span class="keyword">if</span> (requestSerializationError) &#123;</span><br><span class="line">        [<span class="keyword">self</span> requestDidFailWithRequest:request error:requestSerializationError];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSAssert</span>(request.requestTask != <span class="literal">nil</span>, <span class="string">@&quot;requestTask should not be nil&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置请求优先级</span></span><br><span class="line">    <span class="comment">// !!Available on iOS 8 +</span></span><br><span class="line">    <span class="keyword">if</span> ([request.requestTask respondsToSelector:<span class="keyword">@selector</span>(priority)]) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (request.requestPriority) &#123;</span><br><span class="line">            <span class="keyword">case</span> YTKRequestPriorityHigh:</span><br><span class="line">                request.requestTask.priority = <span class="built_in">NSURLSessionTaskPriorityHigh</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YTKRequestPriorityLow:</span><br><span class="line">                request.requestTask.priority = <span class="built_in">NSURLSessionTaskPriorityLow</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YTKRequestPriorityDefault:</span><br><span class="line">                <span class="comment">/*!!fall through*/</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                request.requestTask.priority = <span class="built_in">NSURLSessionTaskPriorityDefault</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    YTKLog(<span class="string">@&quot;Add request: %@&quot;</span>, <span class="built_in">NSStringFromClass</span>([request <span class="keyword">class</span>]));</span><br><span class="line">    <span class="comment">// 将 请求对象 加入记录表</span></span><br><span class="line">    [<span class="keyword">self</span> addRequestToRecord:request];</span><br><span class="line">    <span class="comment">// 执行请求，即执行任务对象</span></span><br><span class="line">    [request.requestTask resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>addRequest:</code> 方法内部会做一下几个步骤的工作：</p>
<ol type="1">
<li>初始化请求对象的关键属性 <code>requestTask</code>，即任务对象。</li>
<li>设置请求优先级</li>
<li>以任务对象的 <code>taskIdentifier</code>
为键，请求对象为值，建立映射关系，存入
<strong>记录表</strong>（即上图中的
<code>_requestRecord</code>，后文还会提到）。</li>
<li>执行请求，本质上是执行任务对象。</li>
</ol>
<p>我们重点看一下第 1 步。这一步默认调用了
<code>sessionTaskForRequest:error:</code>
方法进行初始化。该方法内部实现如下： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionTask</span> *)sessionTaskForRequest:(YTKBaseRequest *)request error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error &#123;</span><br><span class="line">    <span class="comment">// 获取请求方法</span></span><br><span class="line">    YTKRequestMethod method = [request requestMethod];</span><br><span class="line">    <span class="comment">// 获取请求URL</span></span><br><span class="line">    <span class="built_in">NSString</span> *url = [<span class="keyword">self</span> buildRequestUrl:request];</span><br><span class="line">    <span class="comment">// 获取请求参数</span></span><br><span class="line">    <span class="type">id</span> param = request.requestArgument;</span><br><span class="line">    <span class="comment">// 获取 HTTP 主体</span></span><br><span class="line">    AFConstructingBlock constructingBlock = [request constructingBodyBlock];</span><br><span class="line">    <span class="comment">// 获取请求序列化器</span></span><br><span class="line">    AFHTTPRequestSerializer *requestSerializer = [<span class="keyword">self</span> requestSerializerForRequest:request];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据请求方法以及下载路径值，初始化相应的任务对象</span></span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodGET:</span><br><span class="line">            <span class="keyword">if</span> (request.resumableDownloadPath) &#123;</span><br><span class="line">                <span class="keyword">return</span> [<span class="keyword">self</span> downloadTaskWithDownloadPath:request.resumableDownloadPath requestSerializer:requestSerializer URLString:url parameters:param progress:request.resumableDownloadProgressBlock error:error];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;GET&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param error:error];</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodPOST:</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;POST&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param constructingBodyWithBlock:constructingBlock error:error];</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodHEAD:</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;HEAD&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param error:error];</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodPUT:</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;PUT&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param error:error];</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodDELETE:</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;DELETE&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param error:error];</span><br><span class="line">        <span class="keyword">case</span> YTKRequestMethodPATCH:</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;PATCH&quot;</span> requestSerializer:requestSerializer URLString:url parameters:param error:error];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>sessionTaskForRequest:error:</code> 方法会根据请求对象的
<code>requestMethod</code> 初始化相应的任务对象。以 <code>POST</code>
请求为例，这里最终会调用
<code>dataTaskWithHTTPMethod:requestSerializer:URLString:parameters:constructingBodyWithBlock:error:</code>
方法。其内部实现如下： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                               requestSerializer:(AFHTTPRequestSerializer *)requestSerializer</span><br><span class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                      parameters:(<span class="type">id</span>)parameters</span><br><span class="line">                       constructingBodyWithBlock:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="type">id</span> &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                                           error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error &#123;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化一个 URLRequest 对象</span></span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        request = [requestSerializer multipartFormRequestWithMethod:method URLString:URLString parameters:parameters constructingBodyWithBlock:block error:error];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request = [requestSerializer requestWithMethod:method URLString:URLString parameters:parameters error:error];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 利用 URLRequest 对象，初始化任务对象，并返回该任务对象</span></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    dataTask = [_manager dataTaskWithRequest:request</span><br><span class="line">                           completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="type">id</span> responseObject, <span class="built_in">NSError</span> *_error) &#123;</span><br><span class="line">                                <span class="comment">// 设置完成回调</span></span><br><span class="line">                               [<span class="keyword">self</span> handleRequestResult:dataTask responseObject:responseObject error:_error];</span><br><span class="line">                           &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>dataTaskWithHTTPMethod:requestSerializer:URLString:parameters:constructingBodyWithBlock:error:</code>
方法根据入参初始化一个 URLRequest
对象，并使用该对象初始化一个任务对象，并返回该任务对象。</p>
<h4 id="完成回调">完成回调</h4>
<p>上述
<code>dataTaskWithHTTPMethod:requestSerializer:URLString:parameters:constructingBodyWithBlock:error:</code>
方法中，初始化任务对象时会设置完成回调。</p>
<p>我们来看看完成回调做了什么工作。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)handleRequestResult:(<span class="built_in">NSURLSessionTask</span> *)task responseObject:(<span class="type">id</span>)responseObject error:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line">    Lock();</span><br><span class="line">    <span class="comment">// 根据任务对象的 taskIdentifier 从记录表中获取请求对象。</span></span><br><span class="line">    YTKBaseRequest *request = _requestsRecord[@(task.taskIdentifier)];</span><br><span class="line">    Unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    YTKLog(<span class="string">@&quot;Finished Request: %@&quot;</span>, <span class="built_in">NSStringFromClass</span>([request <span class="keyword">class</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span> * __autoreleasing serializationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSError</span> * __autoreleasing validationError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span> *requestError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">BOOL</span> succeed = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据不同的响应序列化器，序列化响应数据</span></span><br><span class="line">    request.responseObject = responseObject;</span><br><span class="line">    <span class="keyword">if</span> ([request.responseObject isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        request.responseData = responseObject;</span><br><span class="line">        request.responseString = [[<span class="built_in">NSString</span> alloc] initWithData:responseObject encoding:[YTKNetworkUtils stringEncodingWithRequest:request]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (request.responseSerializerType) &#123;</span><br><span class="line">            <span class="keyword">case</span> YTKResponseSerializerTypeHTTP:</span><br><span class="line">                <span class="comment">// Default serializer. Do nothing.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YTKResponseSerializerTypeJSON:</span><br><span class="line">                request.responseObject = [<span class="keyword">self</span>.jsonResponseSerializer responseObjectForResponse:task.response data:request.responseData error:&amp;serializationError];</span><br><span class="line">                request.responseJSONObject = request.responseObject;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YTKResponseSerializerTypeXMLParser:</span><br><span class="line">                request.responseObject = [<span class="keyword">self</span>.xmlParserResponseSerialzier responseObjectForResponse:task.response data:request.responseData error:&amp;serializationError];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查请求是否成功，并获取请求异常</span></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        succeed = <span class="literal">NO</span>;</span><br><span class="line">        requestError = error;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">        succeed = <span class="literal">NO</span>;</span><br><span class="line">        requestError = serializationError;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        succeed = [<span class="keyword">self</span> validateResult:request error:&amp;validationError];</span><br><span class="line">        requestError = validationError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用请求成功处理 或 调用请求失败处理</span></span><br><span class="line">    <span class="keyword">if</span> (succeed) &#123;</span><br><span class="line">        [<span class="keyword">self</span> requestDidSucceedWithRequest:request];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> requestDidFailWithRequest:request error:requestError];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从记录表中删除请求对象</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> removeRequestFromRecord:request];</span><br><span class="line">        [request clearCompletionBlock];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在这个回调中，主要做了一下几个工作：</p>
<ol type="1">
<li>根据任务对象的 <code>taskIdentifier</code> 从记录表
<code>_requestRecord</code> 中获取请求对象。</li>
<li>对于获取到的请求对象，根据不同的响应序列化器，序列化响应数据。</li>
<li>检查请求是否成功，并获取请求异常。</li>
<li>调用请求成功处理 或 调用请求失败处理</li>
<li>从记录表中删除请求对象。</li>
</ol>
<p>其中第 4 步，无论是成功回调还是失败回调，都会依次调用代理对象实现的
<code>requestFinished:</code> 或
<code>requestFailed</code>，以及请求对象的
<code>successCompletionBlock</code> 或
<code>failureCompletionBlock</code>。</p>
<h4 id="下载任务与缓存">下载任务与缓存</h4>
<p>关于下载任务，我们先来看一下上述
<code>sessionTaskForRequest:error:</code> 方法中，当请求对象的请求类型是
<code>YTKRequestMethodGET</code> 且设置了请求对象的
<code>resumableDownloadPath</code> 属性时，会调用
<code>downloadTaskWithDownloadPath:requestSerializer:URLString:parameters:progress:error:</code>
方法。该方法的具体实现如下： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithDownloadPath:(<span class="built_in">NSString</span> *)downloadPath</span><br><span class="line">                                         requestSerializer:(AFHTTPRequestSerializer *)requestSerializer</span><br><span class="line">                                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                                parameters:(<span class="type">id</span>)parameters</span><br><span class="line">                                                  progress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress))downloadProgressBlock</span><br><span class="line">                                                     error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error &#123;</span><br><span class="line">    <span class="comment">// 使用请求参数、请求URL、请求类型，初始化 URLRequest 对象</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *urlRequest = [requestSerializer requestWithMethod:<span class="string">@&quot;GET&quot;</span> URLString:URLString parameters:parameters error:error];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *downloadTargetPath;</span><br><span class="line">    <span class="comment">// 检查 resumableDownloadPath 指定的下载存储路径是否是目录</span></span><br><span class="line">    <span class="type">BOOL</span> isDirectory;</span><br><span class="line">    <span class="keyword">if</span>(![[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:downloadPath isDirectory:&amp;isDirectory]) &#123;</span><br><span class="line">        isDirectory = <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 预处理下载存储路径，确保不是目录，而是文件</span></span><br><span class="line">    <span class="keyword">if</span> (isDirectory) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *fileName = [urlRequest.URL lastPathComponent];</span><br><span class="line">        downloadTargetPath = [<span class="built_in">NSString</span> pathWithComponents:@[downloadPath, fileName]];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        downloadTargetPath = downloadPath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理该路径原有的文件</span></span><br><span class="line">    <span class="keyword">if</span> ([[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:downloadTargetPath]) &#123;</span><br><span class="line">        [[<span class="built_in">NSFileManager</span> defaultManager] removeItemAtPath:downloadTargetPath error:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查未完成下载暂存路径是否有数据 并 读取此路径暂存的数据</span></span><br><span class="line">    <span class="type">BOOL</span> resumeDataFileExists = [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:[<span class="keyword">self</span> incompleteDownloadTempPathForDownloadPath:downloadPath].path];</span><br><span class="line">    <span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:[<span class="keyword">self</span> incompleteDownloadTempPathForDownloadPath:downloadPath]];</span><br><span class="line">    <span class="type">BOOL</span> resumeDataIsValid = [YTKNetworkUtils validateResumeData:data];</span><br><span class="line"></span><br><span class="line">    <span class="type">BOOL</span> canBeResumed = resumeDataFileExists &amp;&amp; resumeDataIsValid;</span><br><span class="line">    <span class="type">BOOL</span> resumeSucceeded = <span class="literal">NO</span>;</span><br><span class="line">    __block <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (canBeResumed) &#123;</span><br><span class="line">        <span class="comment">// 对于可恢复的下载请求，使用已下载的数据初始化一个下载任务，继续发起下载请求。</span></span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            downloadTask = [_manager downloadTaskWithResumeData:data progress:downloadProgressBlock destination:^<span class="built_in">NSURL</span> * _Nonnull(<span class="built_in">NSURL</span> * _Nonnull targetPath, <span class="built_in">NSURLResponse</span> * _Nonnull response) &#123;</span><br><span class="line">                <span class="keyword">return</span> [<span class="built_in">NSURL</span> fileURLWithPath:downloadTargetPath isDirectory:<span class="literal">NO</span>];</span><br><span class="line">            &#125; completionHandler:</span><br><span class="line">                            ^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="built_in">NSURL</span> * _Nullable filePath, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">                                [<span class="keyword">self</span> handleRequestResult:downloadTask responseObject:filePath error:error];</span><br><span class="line">                            &#125;];</span><br><span class="line">            resumeSucceeded = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            YTKLog(<span class="string">@&quot;Resume download failed, reason = %@&quot;</span>, exception.reason);</span><br><span class="line">            resumeSucceeded = <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!resumeSucceeded) &#123;</span><br><span class="line">        <span class="comment">// 如果尝试继续下载失败，则创建一个下载任务，重新开始发起下载请求。</span></span><br><span class="line">        downloadTask = [_manager downloadTaskWithRequest:urlRequest progress:downloadProgressBlock destination:^<span class="built_in">NSURL</span> * _Nonnull(<span class="built_in">NSURL</span> * _Nonnull targetPath, <span class="built_in">NSURLResponse</span> * _Nonnull response) &#123;</span><br><span class="line">            <span class="comment">// 指定下载的存储路径</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">NSURL</span> fileURLWithPath:downloadTargetPath isDirectory:<span class="literal">NO</span>];</span><br><span class="line">        &#125; completionHandler:</span><br><span class="line">                        ^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="built_in">NSURL</span> * _Nullable filePath, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">                            [<span class="keyword">self</span> handleRequestResult:downloadTask responseObject:filePath error:error];</span><br><span class="line">                        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> downloadTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
下载任务的创建过程中，有三个关键步骤：</p>
<ol type="1">
<li>确保下载存储路径是文件路径，而非目录路径。</li>
<li>读取 <strong>未完成下载暂存路径</strong>
的数据，并判断是否可继续下载。</li>
<li>如果可以继续下载，则创建请求继续下载；否则，创建请求重新下载。</li>
</ol>
<p>从上面代码中，我们可以知道下载存储路径有两种可能：</p>
<ol type="1">
<li><code>resumableDownloadPath</code></li>
<li><code>resumableDownloadPath</code> + <code>filename</code></li>
</ol>
<p>那么未完成下载暂存路径是什么呢？我们来看代码： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)incompleteDownloadTempCacheFolder &#123;</span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> new];</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *cacheFolder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cacheFolder) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *cacheDir = <span class="built_in">NSTemporaryDirectory</span>();</span><br><span class="line">        cacheFolder = [cacheDir stringByAppendingPathComponent:kYTKNetworkIncompleteDownloadFolderName];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span>(![fileManager createDirectoryAtPath:cacheFolder withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:&amp;error]) &#123;</span><br><span class="line">        YTKLog(<span class="string">@&quot;Failed to create cache directory at %@&quot;</span>, cacheFolder);</span><br><span class="line">        cacheFolder = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cacheFolder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURL</span> *)incompleteDownloadTempPathForDownloadPath:(<span class="built_in">NSString</span> *)downloadPath &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *tempPath = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *md5URLString = [YTKNetworkUtils md5StringFromString:downloadPath];</span><br><span class="line">    tempPath = [[<span class="keyword">self</span> incompleteDownloadTempCacheFolder] stringByAppendingPathComponent:md5URLString];</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSURL</span> fileURLWithPath:tempPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
从上述代码，可以看出未完成下载暂存路径其实就是：</p>
<ul>
<li><code>NSTemporaryDirectory()</code> + 下载存储路径目录的 md5 值</li>
</ul>
<p>注意，<code>NSTemporaryDirectory()</code> 目录就是 UNIX 中的
<code>/tmp</code> 目录，该目录下的文件会在系统重启后被清空。</p>
<h2 id="ytknetwork-链式请求">YTKNetwork 链式请求</h2>
<p><img
src="https://chuquan-public-r-001.oss-cn-shanghai.aliyuncs.com/sketch-images/ytknetwork-chain-overview.png?x-oss-process=image/resize,w_800" /></p>
<p>链式请求主要是通过 YTKNetwork 提供的两个类，并结合 YTKNetwork
核心功能实现的。这两类分别是：</p>
<ul>
<li><code>YTKChainRequest</code></li>
<li><code>YTKChainRequestAgent</code></li>
</ul>
<p>下面，我们分别介绍一下 <code>YTKChainRequest</code> 和
<code>YTKChainRequestAgent</code>。</p>
<h3 id="ytkchainrequest">YTKChainRequest</h3>
<p><code>YTKChainRequest</code> 继承自
<code>NSObject</code>，主要包含一下这些属性。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 公开属性</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKChainRequest</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代理对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span>&lt;YTKChainRequestDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// YTKRequestAccessory 是一个协议，声明了三个方法，允许开发者分别在请求执行的三个阶段(start、willStop、didStop)调用。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="type">id</span>&lt;YTKRequestAccessory&gt;&gt; *requestAccessories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// ------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 私有属性</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKChainRequest</span>()&lt;<span class="title">YTKRequestDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 链式请求队列</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span>&lt;YTKBaseRequest *&gt; *requestArray;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 链式请求回调队列</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span>&lt;YTKChainCallback&gt; *requestCallbackArray;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> nextRequestIndex;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) YTKChainCallback emptyCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p><code>YTKChainRequest</code> 提供了 4 个方法。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 获取链式请求队列</span></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;YTKBaseRequest *&gt; *)requestArray;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 添加实现了 YTKRequestAccessory 协议的对象</span></span><br><span class="line">- (<span class="type">void</span>)addAccessory:(<span class="type">id</span>&lt;YTKRequestAccessory&gt;)accessory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 开始执行链式请求</span></span><br><span class="line">- (<span class="type">void</span>)start;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 停止执行链式请求</span></span><br><span class="line">- (<span class="type">void</span>)stop;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 向链式请求队列中添加请求</span></span><br><span class="line">- (<span class="type">void</span>)addRequest:(YTKBaseRequest *)request callback:(<span class="keyword">nullable</span> YTKChainCallback)callback;</span><br></pre></td></tr></table></figure></p>
<p>我们通过源代码来看一下其中比较关键的 <code>start</code> 方法。
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)start &#123;</span><br><span class="line">    <span class="comment">// 判断链式请求是否已经启动</span></span><br><span class="line">    <span class="keyword">if</span> (_nextRequestIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        YTKLog(<span class="string">@&quot;Error! Chain request has already started.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 链式请求队列非空，则开始执行请求</span></span><br><span class="line">    <span class="keyword">if</span> ([_requestArray count] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> toggleAccessoriesWillStartCallBack];</span><br><span class="line">        [<span class="keyword">self</span> startNextRequest];</span><br><span class="line">        [[YTKChainRequestAgent sharedAgent] addChainRequest:<span class="keyword">self</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        YTKLog(<span class="string">@&quot;Error! Chain request array is empty.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>start</code>
方法内部首先判断链式请求是否已经启动，这是通过请求索引
<code>_nextRequestIndex</code>
来判断的。如果链式请求未启动，则开始执行链式请求，这里调用了一个关键的方法
<code>startNextRequest</code>。 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)startNextRequest &#123;</span><br><span class="line">    <span class="keyword">if</span> (_nextRequestIndex &lt; [_requestArray count]) &#123;</span><br><span class="line">        YTKBaseRequest *request = _requestArray[_nextRequestIndex];</span><br><span class="line">        _nextRequestIndex++;</span><br><span class="line">        request.delegate = <span class="keyword">self</span>;</span><br><span class="line">        [request clearCompletionBlock];</span><br><span class="line">        [request start];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 每调用一次
<code>startNextRequest</code>，会移动请求索引、设置请求代理并执行。</p>
<p>链式请求中的每一个请求 <code>YTKBaseRequest</code> 的代理都是链式请求
<code>YTKChainRequest</code>。<code>YTKChainRequest</code> 实现了
<code>YTKRequestDelegate</code>
协议。每一个请求执行完成后，开始执行下一个请求。如果有一个请求失败，即整个链式请求失败。
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)requestFinished:(YTKBaseRequest *)request &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> currentRequestIndex = _nextRequestIndex - <span class="number">1</span>;</span><br><span class="line">    YTKChainCallback callback = _requestCallbackArray[currentRequestIndex];</span><br><span class="line">    callback(<span class="keyword">self</span>, request);</span><br><span class="line">    <span class="comment">// 执行下一个请求</span></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> startNextRequest]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> toggleAccessoriesWillStopCallBack];</span><br><span class="line">        <span class="keyword">if</span> ([_delegate respondsToSelector:<span class="keyword">@selector</span>(chainRequestFinished:)]) &#123;</span><br><span class="line">            <span class="comment">// 所有请求执行完毕，调用代理方法 chainRequestFinished:</span></span><br><span class="line">            [_delegate chainRequestFinished:<span class="keyword">self</span>];</span><br><span class="line">            [[YTKChainRequestAgent sharedAgent] removeChainRequest:<span class="keyword">self</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> toggleAccessoriesDidStopCallBack];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)requestFailed:(YTKBaseRequest *)request &#123;</span><br><span class="line">    [<span class="keyword">self</span> toggleAccessoriesWillStopCallBack];</span><br><span class="line">    <span class="keyword">if</span> ([_delegate respondsToSelector:<span class="keyword">@selector</span>(chainRequestFailed:failedBaseRequest:)]) &#123;</span><br><span class="line">        <span class="comment">// 有一个请求失败，即调用 chainRequestFailed:</span></span><br><span class="line">        [_delegate chainRequestFailed:<span class="keyword">self</span> failedBaseRequest:request];</span><br><span class="line">        [[YTKChainRequestAgent sharedAgent] removeChainRequest:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> toggleAccessoriesDidStopCallBack];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ytkchainrequestagent">YTKChainRequestAgent</h3>
<p><code>YTKChainRequestAgent</code>
的作用非常简单，就是作为一个单例，持有多个链式请求。<code>YTKChainRequestAgent</code>
提供的方法如下： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (YTKChainRequestAgent *)sharedAgent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 添加链式请求</span></span><br><span class="line">- (<span class="type">void</span>)addChainRequest:(YTKChainRequest *)request;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 移除链式请求</span></span><br><span class="line">- (<span class="type">void</span>)removeChainRequest:(YTKChainRequest *)request;</span><br></pre></td></tr></table></figure></p>
<h2 id="ytknetwork-批量请求">YTKNetwork 批量请求</h2>
<p><img
src="https://chuquan-public-r-001.oss-cn-shanghai.aliyuncs.com/sketch-images/ytknetwork-batch-overview.png?x-oss-process=image/resize,w_800" /></p>
<p><code>YTKNetwork</code>
批量请求的实现原理其实与链式请求的实现原理是一样的，也提供了两个类：</p>
<ul>
<li><code>YTKBatchRequest</code></li>
<li><code>YTKBatchRequestAgent</code></li>
</ul>
<p>不同之处在于，<code>YTKBatchRequest</code> 中的单个请求并不是
<code>YTKBaseRequest</code> 请求，而是它的子类
<code>YTKRequest</code>。</p>
<p>我们来看看 <code>YTKRequest</code> 在父类 <code>YTKBaseRequest</code>
的基础上做了些什么。</p>
<h3 id="ytkrequest">YTKRequest</h3>
<p>首先，我们来看一下 <code>YTKRequest</code> 所提供的外部属性和方法。
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKRequest</span> : <span class="title">YTKBaseRequest</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否忽略缓存</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> ignoreCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 请求响应数据是否来自本地缓存</span></span><br><span class="line">- (<span class="type">BOOL</span>)loadCacheWithError:(<span class="built_in">NSError</span> * __autoreleasing *)error;</span><br><span class="line"><span class="comment">/// 请求不使用缓存数据</span></span><br><span class="line">- (<span class="type">void</span>)startWithoutCache;</span><br><span class="line"><span class="comment">/// 将响应数据保存至缓存</span></span><br><span class="line">- (<span class="type">void</span>)saveResponseDataToCacheFile:(<span class="built_in">NSData</span> *)data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Subclass Override</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 缓存时间</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)cacheTimeInSeconds;</span><br><span class="line"><span class="comment">/// 缓存版本</span></span><br><span class="line">- (<span class="type">long</span> <span class="type">long</span>)cacheVersion;</span><br><span class="line"><span class="comment">/// 缓存敏感数据，用于验证缓存是否失效</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="type">id</span>)cacheSensitiveData;</span><br><span class="line"><span class="comment">/// 是否异步写入缓存</span></span><br><span class="line">- (<span class="type">BOOL</span>)writeCacheAsynchronously;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure> 很明显，<code>YTKRequest</code>
在父类的基础上支持了本地缓存功能。</p>
<h4 id="缓存目录">缓存目录</h4>
<p>我们来重点看一下 <code>YTKRequest</code>
中相关的缓存目录。首先来看以下几个方法： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cacheBasePath &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *pathOfLibrary = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSLibraryDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) objectAtIndex:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *path = [pathOfLibrary stringByAppendingPathComponent:<span class="string">@&quot;LazyRequestCache&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Filter cache base path</span></span><br><span class="line">    <span class="built_in">NSArray</span>&lt;<span class="type">id</span>&lt;YTKCacheDirPathFilterProtocol&gt;&gt; *filters = [[YTKNetworkConfig sharedConfig] cacheDirPathFilters];</span><br><span class="line">    <span class="keyword">if</span> (filters.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">id</span>&lt;YTKCacheDirPathFilterProtocol&gt; f <span class="keyword">in</span> filters) &#123;</span><br><span class="line">            path = [f filterCacheDirPath:path withRequest:<span class="keyword">self</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> createDirectoryIfNeeded:path];</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cacheFileName &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *requestUrl = [<span class="keyword">self</span> requestUrl];</span><br><span class="line">    <span class="built_in">NSString</span> *baseUrl = [YTKNetworkConfig sharedConfig].baseUrl;</span><br><span class="line">    <span class="type">id</span> argument = [<span class="keyword">self</span> cacheFileNameFilterForRequestArgument:[<span class="keyword">self</span> requestArgument]];</span><br><span class="line">    <span class="built_in">NSString</span> *requestInfo = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;Method:%ld Host:%@ Url:%@ Argument:%@&quot;</span>,</span><br><span class="line">                             (<span class="type">long</span>)[<span class="keyword">self</span> requestMethod], baseUrl, requestUrl, argument];</span><br><span class="line">    <span class="built_in">NSString</span> *cacheFileName = [YTKNetworkUtils md5StringFromString:requestInfo];</span><br><span class="line">    <span class="keyword">return</span> cacheFileName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cacheFilePath &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *cacheFileName = [<span class="keyword">self</span> cacheFileName];</span><br><span class="line">    <span class="built_in">NSString</span> *path = [<span class="keyword">self</span> cacheBasePath];</span><br><span class="line">    path = [path stringByAppendingPathComponent:cacheFileName];</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cacheMetadataFilePath &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *cacheMetadataFileName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@.metadata&quot;</span>, [<span class="keyword">self</span> cacheFileName]];</span><br><span class="line">    <span class="built_in">NSString</span> *path = [<span class="keyword">self</span> cacheBasePath];</span><br><span class="line">    path = [path stringByAppendingPathComponent:cacheMetadataFileName];</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
默认情况下，<code>cacheBasePath</code>
方法返回的基本路径是：<code>/Library/LazyRequestCache</code>。</p>
<p><code>cacheFileName</code>
方法则根据请求的基本信息生成缓存的文件名：<code>Method:xxx Host:xxx Url:xxx Argument:xxx</code>，并使用
md5 进行编码。</p>
<p><code>cacheFilePath</code>
则是请求数据的完整存储路径：<code>/Library/LazyRequestCache/</code> +
md5(<code>Method:xxx Host:xxx Url:xxx Argument:xxx</code>)。</p>
<p><code>cacheMetadataFilePath</code>
则存储了缓存元数据，其路径是：<code>cacheFilePath</code> +
<code>.medata</code>。</p>
<p>缓存元数据使用 <code>YTKCacheMetaData</code> 对象表示，其定义如下：
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YTKCacheMetadata</span> : <span class="title">NSObject</span>&lt;<span class="title">NSSecureCoding</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">long</span> <span class="type">long</span> version;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *sensitiveDataString;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDate</span> *creationDate;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *appVersionString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p><code>YTKCacheMetaData</code>
主要用户验证缓存是否有效。验证方法如下： <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)validateCacheWithError:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error &#123;</span><br><span class="line">    <span class="comment">// Date</span></span><br><span class="line">    <span class="built_in">NSDate</span> *creationDate = <span class="keyword">self</span>.cacheMetadata.creationDate;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> duration = -[creationDate timeIntervalSinceNow];</span><br><span class="line">    <span class="keyword">if</span> (duration &lt; <span class="number">0</span> || duration &gt; [<span class="keyword">self</span> cacheTimeInSeconds]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Version</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> cacheVersionFileContent = <span class="keyword">self</span>.cacheMetadata.version;</span><br><span class="line">    <span class="keyword">if</span> (cacheVersionFileContent != [<span class="keyword">self</span> cacheVersion]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Sensitive data</span></span><br><span class="line">    <span class="built_in">NSString</span> *sensitiveDataString = <span class="keyword">self</span>.cacheMetadata.sensitiveDataString;</span><br><span class="line">    <span class="built_in">NSString</span> *currentSensitiveDataString = ((<span class="built_in">NSObject</span> *)[<span class="keyword">self</span> cacheSensitiveData]).description;</span><br><span class="line">    <span class="keyword">if</span> (sensitiveDataString || currentSensitiveDataString) &#123;</span><br><span class="line">        <span class="comment">// If one of the strings is nil, short-circuit evaluation will trigger</span></span><br><span class="line">        <span class="keyword">if</span> (sensitiveDataString.length != currentSensitiveDataString.length || ![sensitiveDataString isEqualToString:currentSensitiveDataString]) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// App version</span></span><br><span class="line">    <span class="built_in">NSString</span> *appVersionString = <span class="keyword">self</span>.cacheMetadata.appVersionString;</span><br><span class="line">    <span class="built_in">NSString</span> *currentAppVersionString = [YTKNetworkUtils appVersionString];</span><br><span class="line">    <span class="keyword">if</span> (appVersionString || currentAppVersionString) &#123;</span><br><span class="line">        <span class="keyword">if</span> (appVersionString.length != currentAppVersionString.length || ![appVersionString isEqualToString:currentAppVersionString]) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="总结">总结</h1>
<p>YTKNetwork 设计原理非常简单，仅仅是对 AFNetworking
做了一个简单的封装，提供了面向对象的使用方法，使用起来也是非常简单。不过也存在缺点，就是每一个请求都需要定义一个类。</p>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a href="https://github.com/yuantiku/YTKNetwork">YTKNetwork</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Bao Chuquan 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="Bao Chuquan 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" rel="tag"># 源码解读</a>
              <a href="/tags/YTKNetwork/" rel="tag"># YTKNetwork</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/08/06/ios-network-afnetworking/" rel="prev" title="iOS 网络(2)——AFNetworking">
                  <i class="fa fa-angle-left"></i> iOS 网络(2)——AFNetworking
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/09/07/world-war-2-su-de/" rel="next" title="二战欧洲东线战场战线动画--苏德战场">
                  二战欧洲东线战场战线动画--苏德战场 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">true</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
  <div>
     <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备16031766号-1</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://vercel.chuquan.me","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"(发表评论)","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"dark":"body.darkmode--activated","visitor":true,"comment_count":true,"requiredFields":["nick"],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2019/08/20/ios-network-ytknetwork/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: false,
  label: '🌓',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script src="/live2dwlib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dwassets/tororo.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":-15,"vOffset":-15},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>
